<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UFABC - Teste de Desempenho da Rede</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: rgb(5, 103, 46);
            --secondary-green: rgb(0, 66, 13);
            --highlight-yellow: rgb(255, 210, 0);
            --white: rgb(255, 255, 255);
            --light-gray: #f7f7f7;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header-banner {
            background-color: var(--primary-green);
            color: var(--white);
            padding: 0.7rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .site-logo img {
            max-width: 90px;
            height: auto;
        }

        .title-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .title-header h1 a {
            color: var(--white);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .title-header h1 a:hover {
            color: var(--highlight-yellow);
        }

        .description-header {
            font-size: 0.9rem;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 0;
        }

        .test-subtitle {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0.4rem 0;
            margin-top: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-container.testing-mode {
            justify-content: flex-start;
            padding-top: 2rem;
        }





        .results-section {
            width: 100%;
            max-width: 1000px;
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .results-section.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .results-header {
            background-color: var(--white);
            border-radius: 12px 12px 0 0;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .results-title {
            color: var(--primary-green);
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid var(--highlight-yellow);
            padding-bottom: 0.5rem;
        }

        #test-status {
            text-align: center;
            font-weight: 500;
            color: var(--secondary-green);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            background-color: var(--white);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .result-item {
            text-align: center;
            padding: 1rem;
            height: 240px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-right: 1px solid var(--medium-gray);
            background-color: var(--white);
            overflow: hidden;
        }

        .result-item:last-child {
            border-right: none;
        }

        .result-label {
            color: var(--dark-gray);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            white-space: nowrap;
        }

        .mini-chart-container {
            height: 120px;
            margin: 0.5rem 0;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .result-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-green);
            margin-top: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.3s ease;
            position: relative;
        }

        .result-live {
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            margin-top: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.8;
            transition: all 0.4s ease;
            transform: translateY(0);
        }

        .result-live.updating {
            color: #0066cc;
            transform: scale(1.05);
            opacity: 1;
        }

        .result-value.final {
            animation: finalPulse 0.8s ease;
            color: #059b2e;
            text-shadow: 0 0 8px rgba(5, 155, 46, 0.3);
        }

        @keyframes finalPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes numberRoll {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .result-value.rolling {
            animation: numberRoll 0.5s ease;
        }


        
        @media (max-width: 1024px) {
            .control-bar {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                text-align: center;
            }
            

            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .result-item {
                border-right: none;
                border-bottom: 1px solid var(--medium-gray);
                height: 280px;
            }
            
            .result-item:last-child {
                border-bottom: none;
            }

            .mini-chart-container {
                height: 180px;
            }

            .title-header h1 {
                font-size: 1.4rem;
            }

            .description-header {
                font-size: 1rem;
            }
        }

        @media (max-width: 768px) {
            /* Banner compacto */
            .header-banner {
                padding: 0.5rem 0;
            }
            
            .site-logo {
                text-align: center;
                margin-bottom: 0.5rem;
            }
            
            .site-logo img {
                max-width: 60px;
            }
            
            .title-header {
                text-align: center;
            }

            .title-header h1 {
                font-size: 1rem;
                margin-bottom: 0.1rem;
            }

            .description-header {
                font-size: 0.75rem;
                margin-bottom: 0.1rem;
            }
            
            .test-subtitle {
                font-size: 0.7rem;
                margin-top: 0.2rem;
                padding: 0.2rem 0;
            }
            
            /* Layout mobile otimizado */
            
            .main-container {
                padding: 0.5rem;
            }

            .main-container.testing-mode {
                padding-top: 0.5rem;
            }

            /* Gráficos grandes no mobile */
            .result-item {
                height: 350px;
                padding: 1rem;
            }

            .mini-chart-container {
                height: 220px;
            }

            .result-value {
                font-size: 1.6rem;
            }


        }

        @media (max-width: 480px) {
            /* Telas muito pequenas - gráficos ainda maiores */
            .result-item {
                height: 400px;
                padding: 0.8rem;
            }

            .mini-chart-container {
                height: 260px;
            }


        }

        /* Layout minimalista redesenhado */
            .control-bar {
            position: relative;
            background: #ffffff;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            width: 100%;
            max-width: 1000px;
            }

            .connection-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0.8;
        }
        
        .connection-badge .badge-text {
            margin-left: 0.25rem;
        }
        
        .badge-direct {
            background: rgba(5, 155, 46, 0.1);
            color: #059b2e;
            border: 1px solid rgba(5, 155, 46, 0.2);
        }
        
        .badge-vpn {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .connection-status-icon {
            font-size: 0.75rem;
        }
        
        .ip-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 0;
        }
        
        .ip-block {
            flex-shrink: 0;
        }
        
        .ipv4-block {
            min-width: 160px;
            max-width: 180px;
        }
        
        .ipv6-block {
            flex: 1;
            min-width: 280px;
            max-width: 420px;
        }
        
        .ip-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .ip-value {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.875rem;
            font-weight: 500;
            color: #212529;
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            word-break: break-all;
            line-height: 1.3;
            min-height: 48px;
            display: flex;
            align-items: center;
        }
        
        .ipv6-value {
            letter-spacing: 0.02em;
            word-spacing: 0.1em;
        }
        
        .action-controls {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-shrink: 0;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .test-button:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        .test-button:disabled {
            background: #6c757d;
            color: #ffffff;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .test-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .test-button .fa-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-button {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-button:hover {
            background: #e9ecef;
            color: #495057;
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .control-bar {
                padding: 1.5rem;
            }
            
            .ip-container {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .ipv4-block,
            .ipv6-block {
                min-width: unset;
                max-width: unset;
                flex: unset;
            }
            
            .action-controls {
                flex-direction: row;
                justify-content: center;
                gap: 1rem;
                margin-top: 1rem;
            }
            
            .test-button {
                flex: 1;
                justify-content: center;
            }
        }
        
        /* Melhorias para o modal */
        .modal-body code {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            display: block;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .accordion-button {
            font-weight: 500;
        }
        
        .accordion-body h6 {
            color: #495057;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .accordion-body h6:first-child {
            margin-top: 0;
        }
        
        .accordion-body p {
            margin-bottom: 0.5rem;
        }
        
        .accordion-body strong {
            color: #007bff;
        }

        /* Estilos para botões de cópia */
        .copy-btn {
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0.8;
        }

        .copy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 1;
        }

        /* Hover effect no container de código */
        .code-container:hover .copy-btn {
            opacity: 1;
        }

        .code-container .copy-btn {
            opacity: 0.8;
        }

        /* Estilo para containers de código */
        .code-container {
            position: relative;
            transition: all 0.3s ease;
        }

        .code-container:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Responsividade para dispositivos móveis */
        @media (max-width: 768px) {
            .copy-btn {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header class="header-banner">
        <div class="container">
            <div class="row w-100">
                <div class="col-12 col-md-2 site-logo py-3">
                    <a href="https://ufabc.edu.br/">
                        <img class="img-fluid" alt="Logo Universidade Federal do ABC - UFABC" src="https://nti.ufabc.edu.br/wp-content/themes/NTI-theme/images/logo2.png">
                    </a>
                </div>
                <div class="col-sm-12 col-md-10">
                    <div class="row">
                        <div class="col-sm-12 pt-2">
                            <div class="row">
                                <div class="col-12">
                                    <div class="title-header">
                                        <h1><a href="https://nti.ufabc.edu.br/">Núcleo de Tecnologia da Informação</a></h1>
                                        <h2 class="description-header">Universidade Federal do ABC</h2>
                                    </div>
                                    <div class="test-subtitle">
                                        <i class="fas fa-network-wired"></i> Sistema de Teste de Velocidade da UFABCnet
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container" id="main-container">
        <div class="control-bar" id="control-bar">
            <div class="connection-badge badge-direct" id="connection-badge">
                <i class="fas fa-spinner fa-spin connection-status-icon"></i>
                <span class="badge-text">detectando...</span>
            </div>
            
            <div class="ip-container">
                <div class="ip-block ipv4-block">
                    <label class="ip-label">IPv4</label>
                    <div class="ip-value" id="ipv4">Carregando...</div>
            </div>
                <div class="ip-block ipv6-block">
                    <label class="ip-label">IPv6</label>
                    <div class="ip-value ipv6-value" id="ipv6">Carregando...</div>
                </div>
                <div class="action-controls">
                    <button id="start-test-btn" class="test-button">
                        <i class="fas fa-play"></i>
                        Testar
                    </button>
                    <button id="explain-btn" class="info-button" type="button" data-bs-toggle="modal" data-bs-target="#explainModal" title="Como funciona o teste?">
                        <i class="fas fa-info"></i>
                </button>
                </div>
            </div>
        </div>

        <div class="results-section" id="results-section">
            <div class="results-header">
                <div class="results-title">Resultados</div>
            </div>
            <div class="results-grid">
                <div class="result-item">
                    <div class="result-label">Download</div>
                    <div class="mini-chart-container">
                        <canvas id="download-chart"></canvas>
                    </div>
                    <div class="result-value" id="download-result">-- Mbps</div>
                    <div class="result-live" id="download-live">aguardando...</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Upload</div>
                    <div class="mini-chart-container">
                        <canvas id="upload-chart"></canvas>
                    </div>
                    <div class="result-value" id="upload-result">-- Mbps</div>
                    <div class="result-live" id="upload-live">aguardando...</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Latência</div>
                    <div class="mini-chart-container">
                        <canvas id="latency-chart"></canvas>
                    </div>
                    <div class="result-value" id="latency-result">-- ms</div>
                    <div class="result-live" id="latency-live">aguardando...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de explicação -->
    <div class="modal fade" id="explainModal" tabindex="-1" aria-labelledby="explainModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="explainModalLabel">
                        <i class="fas fa-terminal text-primary"></i> Como funciona o teste?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="explanationAccordion">
                        <!-- Visão Geral -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOverview">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOverview">
                                    <i class="fas fa-info-circle text-info me-2"></i>Visão Geral
                                </button>
                            </h2>
                            <div id="collapseOverview" class="accordion-collapse collapse show" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <p>Os testes de velocidade são realizados através de <strong>HTTP direto</strong> entre seu navegador e o servidor para medir precisamente a performance da sua conexão de rede.</p>
                                    <p>Todos os testes são executados no <strong>cliente</strong> (seu navegador) medindo o tempo real de transferência entre sua máquina e o servidor.</p>
                                    <p>Esta abordagem testa a velocidade real da sua conexão, não a velocidade do servidor ou loopback local.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Teste de Latência -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingLatency">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLatency">
                                    <i class="fas fa-clock text-warning me-2"></i>Teste de Latência (Ping)
                                </button>
                            </h2>
                            <div id="collapseLatency" class="accordion-collapse collapse" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <h6>Comando utilizado:</h6>
                                    <code>ping -c 1 meuip.ufabc.int.br</code>
                                    
                                    <h6 class="mt-3">Processo:</h6>
                                    <ol>
                                        <li>Executa 12 pings individuais (1 pacote cada)</li>
                                        <li>Intervalo de 500ms entre cada ping</li>
                                        <li>Extrai o tempo de resposta em milissegundos</li>
                                        <li>Apresenta cada resultado imediatamente</li>
                                    </ol>
                                    
                                    <h6 class="mt-3">Resultado exemplo:</h6>
                                    <p><code>64 bytes from meuip.ufabc.int.br: icmp_seq=1 time=12.4 ms</code></p>
                                    <p>O tempo medido é o <strong>round-trip time (RTT)</strong> - o tempo total da viagem de ida e volta.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Teste de Download -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingDownload">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDownload">
                                    <i class="fas fa-download text-success me-2"></i>Teste de Download
                                </button>
                            </h2>
                            <div id="collapseDownload" class="accordion-collapse collapse" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <h6>Método utilizado:</h6>
                                    <code>fetch('/testfile') + performance.now()</code>
                                    
                                    <h6 class="mt-3">Processo:</h6>
                                    <ol>
                                        <li>Navegador baixa arquivo de teste de 1MB do servidor</li>
                                        <li>Mede tempo usando performance.now() (alta precisão)</li>
                                        <li>Calcula velocidade: (bytes × 8) / (tempo × 1.000.000)</li>
                                        <li>Testa velocidade real cliente-servidor</li>
                                    </ol>
                                    
                                    <h6 class="mt-3">Exemplo de cálculo:</h6>
                                    <p><code>1.048.576 bytes em 0.125 segundos</code></p>
                                    <p>Velocidade: (1.048.576 × 8) / (0.125 × 1.000.000)</p>
                                    <p>Resultado: <strong>67 Mbps</strong></p>
                                </div>
                            </div>
                        </div>

                        <!-- Teste de Upload -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingUpload">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpload">
                                    <i class="fas fa-upload text-primary me-2"></i>Teste de Upload
                                </button>
                            </h2>
                            <div id="collapseUpload" class="accordion-collapse collapse" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <h6>Método utilizado:</h6>
                                    <code>fetch('/upload', {method: 'POST', body: testData}) + performance.now()</code>
                                    
                                    <h6 class="mt-3">Processo:</h6>
                                    <ol>
                                        <li>JavaScript cria dados de teste de 1MB (Uint8Array)</li>
                                        <li>Navegador envia dados via POST para servidor</li>
                                        <li>Mede tempo usando performance.now() (alta precisão)</li>
                                        <li>Testa velocidade real cliente-servidor</li>
                                    </ol>
                                    
                                    <h6 class="mt-3">Exemplo de cálculo:</h6>
                                    <p><code>1.048.576 bytes em 0.156 segundos</code></p>
                                    <p>Velocidade: (1.048.576 × 8) / (0.156 × 1.000.000)</p>
                                    <p>Resultado: <strong>54 Mbps</strong></p>
                                </div>
                            </div>
                        </div>

                        <!-- Usuários Avançados -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingAdvanced">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                                    <i class="fas fa-terminal text-dark me-2"></i>Para Usuários Avançados
                                </button>
                            </h2>
                            <div id="collapseAdvanced" class="accordion-collapse collapse" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Para especialistas em rede:</strong> Use os comandos abaixo para validar e comparar os resultados da interface web.
                                    </div>

                                    <!-- Navegação por Sistema Operacional -->
                                    <ul class="nav nav-pills nav-justified mb-3" id="osNavigation" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="linux-mac-tab" data-bs-toggle="pill" data-bs-target="#linux-mac" type="button" role="tab">
                                                <i class="fab fa-linux me-2"></i>Linux/macOS
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="windows-tab" data-bs-toggle="pill" data-bs-target="#windows" type="button" role="tab">
                                                <i class="fab fa-windows me-2"></i>Windows
                                            </button>
                                        </li>
                                    </ul>

                                    <!-- Conteúdo por Sistema Operacional -->
                                    <div class="tab-content" id="osTabContent">
                                        
                                        <!-- Linux/macOS -->
                                        <div class="tab-pane fade show active" id="linux-mac" role="tabpanel">
                                            <!-- Sub-navegação Linux/macOS -->
                                            <ul class="nav nav-pills nav-justified mb-3" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="bash-script-tab" data-bs-toggle="tab" data-bs-target="#bash-script" type="button" role="tab">
                                                        <i class="fas fa-file-code me-1"></i>Script Completo
                                                        <span class="badge bg-success ms-1">Recomendado</span>
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="linux-individual-tab" data-bs-toggle="tab" data-bs-target="#linux-individual" type="button" role="tab">
                                                        <i class="fas fa-terminal me-1"></i>Comandos Únicos
                                                    </button>
                                                </li>
                                            </ul>

                                            <!-- Conteúdo Linux/macOS -->
                                            <div class="tab-content">
                                                <!-- Script Bash -->
                                                <div class="tab-pane fade show active" id="bash-script" role="tabpanel">
                                                    <div class="bg-dark text-light p-3 rounded mb-3 position-relative code-container">
                                                        <div class="pe-5">
                                                            <code class="text-success">curl -O http://meuip.ufabc.int.br/validate_speed.sh && chmod +x validate_speed.sh && ./validate_speed.sh</code>
                                                        </div>
                                                        <button class="btn btn-success btn-sm position-absolute top-50 end-0 translate-middle-y me-2 copy-btn" onclick="copyToClipboard('curl -O http://meuip.ufabc.int.br/validate_speed.sh && chmod +x validate_speed.sh && ./validate_speed.sh')" title="Copiar comando">
                                                            <i class="fas fa-copy me-1"></i>Copiar
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- Informações extras (colapsável) -->
                                                    <div class="accordion" id="bashAccordion">
                                                        <div class="accordion-item">
                                                            <h2 class="accordion-header">
                                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#bashDetails">
                                                                    <i class="fas fa-info-circle me-2"></i>Detalhes e Opções
                                                                </button>
                                                            </h2>
                                                            <div id="bashDetails" class="accordion-collapse collapse" data-bs-parent="#bashAccordion">
                                                                <div class="accordion-body">
                                                                    <div class="row">
                                                                        <div class="col-md-6">
                                                                            <h6>🚀 Execução Personalizada:</h6>
                                                                            <div class="bg-dark text-light p-2 rounded mb-2">
                                                                                <code class="small">./validate_speed.sh 24</code>
                                                                            </div>
                                                                            <p class="small text-muted">24 testes por métrica (padrão: 12)</p>
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                            <h6>🛠️ Recursos:</h6>
                                                                            <ul class="small">
                                                                                <li>Retry automático (10x)</li>
                                                                                <li>Estatísticas precisas</li>
                                                                                <li>Auto-delete</li>
                                                                                <li>Compatível macOS/Linux</li>
                                                                            </ul>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Comandos Individuais Linux -->
                                                <div class="tab-pane fade" id="linux-individual" role="tabpanel">
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <h6 class="text-muted small mb-2">🔽 Download</h6>
                                                            <div class="bg-dark text-light p-2 rounded position-relative code-container">
                                                                <div class="pe-4">
                                                                    <code class="text-success small">curl -s -o /dev/null -w "%{speed_download}" http://meuip.ufabc.int.br/testfile</code>
                                                                </div>
                                                                <button class="btn btn-outline-success btn-sm position-absolute top-0 end-0 copy-btn" onclick="copyToClipboard('curl -s -o /dev/null -w \"%{speed_download}\" http://meuip.ufabc.int.br/testfile')" title="Copiar">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <h6 class="text-muted small mb-2">🔼 Upload</h6>
                                                            <div class="bg-dark text-light p-2 rounded position-relative code-container">
                                                                <div class="pe-4">
                                                                    <code class="text-success small">dd if=/dev/zero bs=1024 count=1024 | curl -s -X POST --data-binary @- -w "%{speed_upload}" http://meuip.ufabc.int.br/upload</code>
                                                                </div>
                                                                <button class="btn btn-outline-success btn-sm position-absolute top-0 end-0 copy-btn" onclick="copyToClipboard('dd if=/dev/zero bs=1024 count=1024 | curl -s -X POST --data-binary @- -w \"%{speed_upload}\" http://meuip.ufabc.int.br/upload')" title="Copiar">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <h6 class="text-muted small mb-2">🏓 Latência</h6>
                                                            <div class="bg-dark text-light p-2 rounded position-relative code-container">
                                                                <div class="pe-4">
                                                                    <code class="text-success small">ping -c 12 meuip.ufabc.int.br</code>
                                                                </div>
                                                                <button class="btn btn-outline-success btn-sm position-absolute top-0 end-0 copy-btn" onclick="copyToClipboard('ping -c 12 meuip.ufabc.int.br')" title="Copiar">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Windows -->
                                        <div class="tab-pane fade" id="windows" role="tabpanel">
                                            <!-- Sub-navegação Windows -->
                                            <ul class="nav nav-pills nav-justified mb-3" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="powershell-script-tab" data-bs-toggle="tab" data-bs-target="#powershell-script" type="button" role="tab">
                                                        <i class="fas fa-file-powerpoint me-1"></i>Script PowerShell
                                                        <span class="badge bg-success ms-1">Recomendado</span>
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="cmd-commands-tab" data-bs-toggle="tab" data-bs-target="#cmd-commands" type="button" role="tab">
                                                        <i class="fas fa-terminal me-1"></i>Comandos CMD
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="windows-alternatives-tab" data-bs-toggle="tab" data-bs-target="#windows-alternatives" type="button" role="tab">
                                                        <i class="fas fa-layer-group me-1"></i>WSL/Git Bash
                                                    </button>
                                                </li>
                                            </ul>

                                            <!-- Conteúdo Windows -->
                                            <div class="tab-content">
                                                <!-- Script PowerShell -->
                                                <div class="tab-pane fade show active" id="powershell-script" role="tabpanel">
                                                    <div class="bg-dark text-light p-3 rounded mb-3 position-relative code-container">
                                                        <div class="pe-5">
                                                            <code class="text-success">curl -O http://meuip.ufabc.int.br/validate_speed.ps1 && powershell -ExecutionPolicy Bypass -File validate_speed.ps1</code>
                                                        </div>
                                                        <button class="btn btn-success btn-sm position-absolute top-50 end-0 translate-middle-y me-2 copy-btn" onclick="copyToClipboard('curl -O http://meuip.ufabc.int.br/validate_speed.ps1 && powershell -ExecutionPolicy Bypass -File validate_speed.ps1')" title="Copiar comando">
                                                            <i class="fas fa-copy me-1"></i>Copiar
                                                        </button>
                                                    </div>

                                                    <!-- Informações extras (colapsável) -->
                                                    <div class="accordion" id="powershellAccordion">
                                                        <div class="accordion-item">
                                                            <h2 class="accordion-header">
                                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#powershellDetails">
                                                                    <i class="fas fa-info-circle me-2"></i>Detalhes e Requisitos
                                                                </button>
                                                            </h2>
                                                            <div id="powershellDetails" class="accordion-collapse collapse" data-bs-parent="#powershellAccordion">
                                                                <div class="accordion-body">
                                                                    <div class="row">
                                                                        <div class="col-md-6">
                                                                            <h6>📋 Requisitos:</h6>
                                                                            <ul class="small">
                                                                                <li>Windows 10/11 (curl nativo)</li>
                                                                                <li>PowerShell 5.1+</li>
                                                                            </ul>
                                                                            <h6>🚀 Execução Personalizada:</h6>
                                                                            <div class="bg-dark text-light p-2 rounded">
                                                                                <code class="small">.\validate_speed.ps1 24</code>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                            <h6>🛠️ Recursos:</h6>
                                                                            <ul class="small">
                                                                                <li>Retry automático (10x)</li>
                                                                                <li>Estatísticas precisas</li>
                                                                                <li>Auto-delete</li>
                                                                                <li>Interface colorida</li>
                                                                            </ul>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Comandos CMD -->
                                                <div class="tab-pane fade" id="cmd-commands" role="tabpanel">
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <h6 class="text-muted small mb-2">🔽 Download</h6>
                                                            <div class="bg-dark text-light p-2 rounded position-relative code-container">
                                                                <div class="pe-4">
                                                                    <code class="text-success small">curl -s -o nul -w "%{speed_download}" http://meuip.ufabc.int.br/testfile</code>
                                                                </div>
                                                                <button class="btn btn-outline-success btn-sm position-absolute top-0 end-0 copy-btn" onclick="copyToClipboard('curl -s -o nul -w \"%{speed_download}\" http://meuip.ufabc.int.br/testfile')" title="Copiar">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <h6 class="text-muted small mb-2">🔼 Upload</h6>
                                                            <div class="bg-dark text-light p-2 rounded position-relative code-container">
                                                                <div class="pe-4">
                                                                    <code class="text-success small">fsutil file createnew temp1mb.dat 1048576 && curl -X POST -T temp1mb.dat -w "%{speed_upload}" http://meuip.ufabc.int.br/upload && del temp1mb.dat</code>
                                                                </div>
                                                                <button class="btn btn-outline-success btn-sm position-absolute top-0 end-0 copy-btn" onclick="copyToClipboard('fsutil file createnew temp1mb.dat 1048576 && curl -X POST -T temp1mb.dat -w \"%{speed_upload}\" http://meuip.ufabc.int.br/upload && del temp1mb.dat')" title="Copiar">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <h6 class="text-muted small mb-2">🏓 Latência</h6>
                                                            <div class="bg-dark text-light p-2 rounded position-relative code-container">
                                                                <div class="pe-4">
                                                                    <code class="text-success small">ping -n 12 meuip.ufabc.int.br</code>
                                                                </div>
                                                                <button class="btn btn-outline-success btn-sm position-absolute top-0 end-0 copy-btn" onclick="copyToClipboard('ping -n 12 meuip.ufabc.int.br')" title="Copiar">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Alternativas Windows -->
                                                <div class="tab-pane fade" id="windows-alternatives" role="tabpanel">
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <div class="card h-100">
                                                                <div class="card-body">
                                                                    <h6 class="card-title">
                                                                        <i class="fas fa-terminal me-2"></i>WSL
                                                                        <span class="badge bg-success ms-1">Melhor</span>
                                                                    </h6>
                                                                    <div class="bg-dark text-light p-2 rounded position-relative">
                                                                        <div class="pe-4">
                                                                            <code class="small">wsl curl -O http://meuip.ufabc.int.br/validate_speed.sh && wsl bash validate_speed.sh</code>
                                                                        </div>
                                                                        <button class="btn btn-outline-success btn-sm position-absolute top-0 end-0 copy-btn" onclick="copyToClipboard('wsl curl -O http://meuip.ufabc.int.br/validate_speed.sh && wsl bash validate_speed.sh')" title="Copiar">
                                                                            <i class="fas fa-copy"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="card h-100">
                                                                <div class="card-body">
                                                                    <h6 class="card-title">
                                                                        <i class="fab fa-git-alt me-2"></i>Git Bash
                                                                    </h6>
                                                                    <div class="bg-dark text-light p-2 rounded position-relative">
                                                                        <div class="pe-4">
                                                                            <code class="small">curl -O http://meuip.ufabc.int.br/validate_speed.sh && bash validate_speed.sh</code>
                                                                        </div>
                                                                        <button class="btn btn-outline-success btn-sm position-absolute top-0 end-0 copy-btn" onclick="copyToClipboard('curl -O http://meuip.ufabc.int.br/validate_speed.sh && bash validate_speed.sh')" title="Copiar">
                                                                            <i class="fas fa-copy"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Informações técnicas (colapsável) -->
                                    <div class="accordion mt-3" id="technicalAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#technicalDetails">
                                                    <i class="fas fa-cogs me-2"></i>Informações Técnicas e Comparação
                                                </button>
                                            </h2>
                                            <div id="technicalDetails" class="accordion-collapse collapse" data-bs-parent="#technicalAccordion">
                                                <div class="accordion-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <h6 class="small text-muted">🌐 INTERFACE WEB:</h6>
                                                            <ul class="small">
                                                                <li><strong>Método:</strong> HTTP fetch() via JavaScript</li>
                                                                <li><strong>Timer:</strong> performance.now() (alta precisão)</li>
                                                                <li><strong>Retry:</strong> 10 tentativas automáticas</li>
                                                                <li><strong>Estatística:</strong> Mediana de 12 testes</li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="small text-muted">💻 CURL/SCRIPT:</h6>
                                                            <ul class="small">
                                                                <li><strong>Método:</strong> Curl nativo (C/libcurl)</li>
                                                                <li><strong>Timer:</strong> Timer interno do curl</li>
                                                                <li><strong>Retry:</strong> 10 tentativas automáticas</li>
                                                                <li><strong>Estatística:</strong> Mediana de N testes</li>
                                                            </ul>
                                                        </div>
                                                    </div>

                                                    <div class="alert alert-info mt-3">
                                                        <i class="fas fa-info-circle me-2"></i>
                                                        <strong>Diferenças Típicas:</strong> ±5-15% de variação normal entre métodos. Curl pode ser ligeiramente mais rápido devido a menos overhead.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import {
            fetchServerInfo,
            testClientIPv4,
            testClientIPv6,
            testDownloadSpeed,
            testUploadSpeed,
            latencyTest
        } from '/modules/network-tests.js';

        // --- DOM Elements ---
        const startTestBtn = document.getElementById('start-test-btn');
        const resultsSection = document.getElementById('results-section');
        const mainContainer = document.getElementById('main-container');
        
        const ipv4Element = document.getElementById('ipv4');
        const ipv6Element = document.getElementById('ipv6');
        const connectionBadge = document.getElementById('connection-badge');

        let downloadChart, uploadChart, latencyChart;

        // --- Test Configuration ---
        const testConfig = {
            location: '',
            results: { download: null, upload: null, latency: null },
            chartLabels: [],
        };

        // --- Funções Auxiliares Robustas ---
        
        // Interpolação ou fallback para valores faltantes
        function interpolateOrFallback(validData, currentIndex) {
            // Se não há dados válidos ainda, usar 0
            if (validData.length === 0) {
                return 0;
            }
            
            // Se há apenas um valor, usar ele
            if (validData.length === 1) {
                return validData[0];
            }
            
            // Se há múltiplos valores, usar interpolação linear simples
            // ou a média dos últimos 2 valores
            const recentValues = validData.slice(-2);
            return recentValues.reduce((a, b) => a + b, 0) / recentValues.length;
        }
        
        // Análise estatística robusta com detecção de outliers
        function calculateRobustStatistics(validSpeeds, totalTests) {
            // Se não há dados válidos, retornar 0
            if (validSpeeds.length === 0) {
                console.warn('⚠️ Nenhum teste válido, retornando 0');
                return 0;
            }
            
            // Se há poucos dados (< 30% de sucesso), usar média simples
            if (validSpeeds.length < totalTests * 0.3) {
                const average = validSpeeds.reduce((a, b) => a + b, 0) / validSpeeds.length;
                console.warn(`⚠️ Poucos dados válidos (${validSpeeds.length}/${totalTests}), usando média: ${Math.round(average)} Mbps`);
                return average;
            }
            
            // Ordenar para calcular mediana e quartis
            const sorted = [...validSpeeds].sort((a, b) => a - b);
            
            // Calcular quartis para detecção de outliers
            const q1Index = Math.floor(sorted.length * 0.25);
            const q3Index = Math.floor(sorted.length * 0.75);
            const q1 = sorted[q1Index];
            const q3 = sorted[q3Index];
            const iqr = q3 - q1;
            
            // Filtrar outliers (valores fora de 1.5 * IQR)
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            const filteredSpeeds = sorted.filter(speed => speed >= lowerBound && speed <= upperBound);
            
            // Se removeu muitos outliers, usar dados originais
            if (filteredSpeeds.length < validSpeeds.length * 0.5) {
                console.log(`📊 Muitos outliers detectados, usando dados originais`);
                const median = sorted[Math.floor(sorted.length / 2)];
                return median;
            }
            
            // Usar mediana dos dados filtrados (mais robusta que média)
            const medianFiltered = filteredSpeeds[Math.floor(filteredSpeeds.length / 2)];
            
            console.log(`📊 Estatísticas - Dados válidos: ${validSpeeds.length}/${totalTests}, Outliers removidos: ${validSpeeds.length - filteredSpeeds.length}, Resultado: ${Math.round(medianFiltered)} Mbps`);
            
            return medianFiltered;
        }



        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialInfo();
            startTestBtn.addEventListener('click', startDiagnostic);
            initCharts();
        });

        // --- Core Functions ---
        async function loadInitialInfo() {
            try {
                const serverInfo = await fetchServerInfo();
                console.log('Server info:', serverInfo);
                
                // Testar pilha dupla de forma paralela e independente
                console.log('🔍 Iniciando teste de pilha dupla...');
                
                // Sempre usar configurações robustas de produção
                console.log('🌍 Configurações de produção sempre aplicadas para máxima robustez');
                
                // Teste 1: Verificar qual stack está sendo usado atualmente
                const currentStackTest = await fetch('/api/dual-stack-test');
                const currentStack = await currentStackTest.json();
                console.log('📊 Stack atual detectado:', currentStack);
                
                // Forçar detecção de ambos os IPs através de múltiplas estratégias
                const dualStackResults = await forceDualStackDetection(serverInfo, currentStack);
                
                // Atualizar interface com os resultados
                ipv4Element.textContent = dualStackResults.ipv4;
                ipv6Element.textContent = dualStackResults.ipv6;
                
                // Determinar tipo de conexão baseado nos IPs detectados
                updateConnectionBadges(dualStackResults.ipv4, dualStackResults.ipv6);
                
                console.log('🎯 Pilha dupla detectada - IPv4:', dualStackResults.ipv4, '| IPv6:', dualStackResults.ipv6);

            } catch (error) {
                console.error('❌ Erro ao carregar informações iniciais:', error);
                ipv4Element.textContent = 'Erro';
                ipv6Element.textContent = 'Erro';
            }
        }

        // Função para forçar detecção de pilha dupla
        async function forceDualStackDetection(serverInfo, currentStack) {
            let ipv4Result = 'Não detectado';
            let ipv6Result = 'Não detectado';
                
            // Estratégia 1: Endpoint padrão (melhor para detecção geral)
            try {
                console.log('🔄 Testando endpoint padrão...');
                const fallbackResponse = await fetch('/api/client-ips');
                const fallbackData = await fallbackResponse.json();
                
                if (fallbackData.ipv4 && fallbackData.ipv4 !== 'Não detectado') {
                    ipv4Result = fallbackData.ipv4;
                    console.log('✅ IPv4 detectado via endpoint padrão:', ipv4Result);
                }
                
                if (fallbackData.ipv6 && fallbackData.ipv6 !== 'Não detectado') {
                    ipv6Result = fallbackData.ipv6;
                    console.log('✅ IPv6 detectado via endpoint padrão:', ipv6Result);
                }
            } catch (error) {
                console.log('⚠️ Endpoint padrão falhou:', error.message);
            }

            // Estratégia 2: Tentar IPv4 específico (se disponível)
            if (serverInfo.ipv4) {
                try {
                    console.log(`🌐 Testando IPv4 via ${serverInfo.ipv4}...`);
                    const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
                    const ipv4Response = await fetch(`http://${serverInfo.ipv4}:${port}/api/client-ips`, {
                        signal: AbortSignal.timeout(8000) // 8 segundos timeout
                    });
                    const ipv4Data = await ipv4Response.json();
                    if (ipv4Data.ipv4 && ipv4Data.ipv4 !== 'Não detectado') {
                        ipv4Result = ipv4Data.ipv4;
                        console.log('✅ IPv4 confirmado via IP específico:', ipv4Result);
                    }
                    if (ipv4Data.ipv6 && ipv4Data.ipv6 !== 'Não detectado' && ipv6Result === 'Não detectado') {
                        ipv6Result = ipv4Data.ipv6;
                        console.log('✅ IPv6 detectado via IPv4 específico:', ipv6Result);
                    }
                } catch (error) {
                    console.log('⚠️ Teste IPv4 específico falhou:', error.message);
                }
            }
                
            // Estratégia 3: Tentar IPv6 específico (se disponível)
            if (serverInfo.ipv6) {
                try {
                    console.log(`🌍 Testando IPv6 via [${serverInfo.ipv6}]...`);
                    const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
                    const ipv6Response = await fetch(`http://[${serverInfo.ipv6}]:${port}/api/client-ips`, {
                        signal: AbortSignal.timeout(8000) // 8 segundos timeout
                    });
                    const ipv6Data = await ipv6Response.json();
                    if (ipv6Data.ipv6 && ipv6Data.ipv6 !== 'Não detectado') {
                        ipv6Result = ipv6Data.ipv6;
                        console.log('✅ IPv6 confirmado via IP específico:', ipv6Result);
                    }
                    if (ipv6Data.ipv4 && ipv6Data.ipv4 !== 'Não detectado' && ipv4Result === 'Não detectado') {
                        ipv4Result = ipv6Data.ipv4;
                        console.log('✅ IPv4 detectado via IPv6 específico:', ipv4Result);
                    }
                } catch (error) {
                    console.log('⚠️ Teste IPv6 específico falhou:', error.message);
                }
            }
                
            // Estratégia 4: Fallback usando currentStack
            if (ipv4Result === 'Não detectado' && currentStack.clientIP) {
                const cleanIP = currentStack.clientIP.replace(/^::ffff:/, '');
                if (cleanIP.includes('.') && cleanIP !== '127.0.0.1') {
                    ipv4Result = cleanIP;
                    console.log('🔄 IPv4 extraído do currentStack:', ipv4Result);
                }
            }
            
            if (ipv6Result === 'Não detectado' && currentStack.clientIP) {
                const cleanIP = currentStack.clientIP;
                if (cleanIP.includes(':') && !cleanIP.startsWith('fe80:') && cleanIP !== '::1' && !cleanIP.includes('::ffff:')) {
                    ipv6Result = cleanIP;
                    console.log('🔄 IPv6 extraído do currentStack:', ipv6Result);
                }
            }
            
            return { ipv4: ipv4Result, ipv6: ipv6Result };
        }

        function updateConnectionBadges(ipv4, ipv6) {
            // Verificar se é VPN
            let isVpn = false;
            let networkType = 'rede interna';
            
            if (ipv4 && ipv4.includes('172.17.4.')) {
                isVpn = true;
                networkType = 'VPN institucional';
            }
            
            // Criar badge moderno com ícone
            const icon = isVpn ? 
                '<i class="fas fa-shield-alt connection-status-icon"></i>' : 
                '<i class="fas fa-network-wired connection-status-icon"></i>';
            
            connectionBadge.innerHTML = `${icon}${networkType}`;
            connectionBadge.className = `connection-badge ${isVpn ? 'badge-vpn' : 'badge-direct'}`;
        }

        async function startDiagnostic() {
            // Determinar tipo de conexão para logs
            const isVpn = connectionBadge.classList.contains('badge-vpn');
            const location = isVpn ? 'VPN Institucional' : 'Rede Interna';
            
            testConfig.location = location;

            // Animações de layout
            mainContainer.classList.add('testing-mode');
            resultsSection.classList.add('visible');

            startTestBtn.disabled = true;
            startTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
            
            resetUI();

            console.log(`🚀 Iniciando diagnóstico via Curl - Localização: ${location}`);

            // Executar testes via Curl
            await runTest('download', runDownloadTest);
            await runTest('upload', runUploadTest);
            await runTest('latency', runLatencyTest);


            startTestBtn.disabled = false;
            startTestBtn.innerHTML = '<i class="fas fa-play"></i> Testar';
        }


        
        function resetUI() {
            // Reset results
            document.getElementById('download-result').textContent = '';
            document.getElementById('upload-result').textContent = '';
            document.getElementById('latency-result').textContent = '';
            
            // Reset live values
            document.getElementById('download-live').textContent = '';
            document.getElementById('upload-live').textContent = '';
            document.getElementById('latency-live').textContent = '';
            
            // Garantir que elementos live estão visíveis
            document.getElementById('download-live').style.display = 'inline';
            document.getElementById('upload-live').style.display = 'inline';
            document.getElementById('latency-live').style.display = 'inline';
            
            // Reset results display
            document.getElementById('download-result').style.display = 'none';
            document.getElementById('upload-result').style.display = 'none';
            document.getElementById('latency-result').style.display = 'none';
            
            // Remove animation classes
            document.getElementById('download-result').classList.remove('final', 'rolling', 'finalPulse');
            document.getElementById('upload-result').classList.remove('final', 'rolling', 'finalPulse');
            document.getElementById('latency-result').classList.remove('final', 'rolling', 'finalPulse');
            
            document.getElementById('download-live').classList.remove('updating');
            document.getElementById('upload-live').classList.remove('updating');
            document.getElementById('latency-live').classList.remove('updating');
            
            // Reset charts
            testConfig.chartLabels = [];
            resetChart(downloadChart);
            resetChart(uploadChart);
            resetChart(latencyChart);
            
            // Limpar histórico de valores
            clearHistory();
        }

        function resetChart(chart) {
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.update('none');
        }

        // Array para armazenar valores históricos para animação
        const valueHistory = {
            download: [],
            upload: [],
            latency: []
        };

        // Controle de animação contínua
        const animationControl = {
            download: { running: false, currentValue: 0, targetValue: 0, animationId: null },
            upload: { running: false, currentValue: 0, targetValue: 0, animationId: null },
            latency: { running: false, currentValue: 0, targetValue: 0, animationId: null }
        };

        // Função para limpar histórico
        function clearHistory() {
            valueHistory.download = [];
            valueHistory.upload = [];
            valueHistory.latency = [];
            
            // Parar todas as animações
            Object.keys(animationControl).forEach(key => {
                if (animationControl[key].animationId) {
                    cancelAnimationFrame(animationControl[key].animationId);
                }
                animationControl[key].running = false;
                animationControl[key].currentValue = 0;
                animationControl[key].targetValue = 0;
                animationControl[key].animationId = null;
            });
        }

        // Função para iniciar o velocímetro contínuo no início do teste
        function startSpeedometer(elementId, unit, isLatency = false) {
            const liveElement = document.getElementById(`${elementId}-live`);
            const resultElement = document.getElementById(`${elementId}-result`);
            
            if (!liveElement) return;
            
            // Preparar interface
            resultElement.textContent = '';
            liveElement.textContent = '';
            liveElement.style.display = 'inline';
            
            // Iniciar animação contínua desde o começo
            animationControl[elementId].currentValue = 0;
            animationControl[elementId].targetValue = 0;
            animationControl[elementId].running = true;
            startContinuousAnimation(elementId, unit, isLatency);
            
            // Log informativo
            console.log(`🎯 ${elementId}: Velocímetro iniciado - convergindo para a média conforme amostras são coletadas`);
        }

        // Função para atualizar valores (calcula média em tempo real)
        function updateLiveValue(elementId, value, unit, isLatency = false) {
            // Adicionar valor ao histórico
            valueHistory[elementId].push(value);
            
            // Calcular média atual das amostras coletadas
            const currentHistory = valueHistory[elementId];
            const currentAverage = currentHistory.reduce((sum, val) => sum + val, 0) / currentHistory.length;
            
            // Atualizar valor alvo para animação contínua (agora é a média)
            if (animationControl[elementId]) {
                animationControl[elementId].targetValue = currentAverage;
            }
            
            // Log para debug
            console.log(`📊 ${elementId}: Amostra ${currentHistory.length} = ${value.toFixed(isLatency ? 3 : 0)} ${unit}, Média atual = ${currentAverage.toFixed(isLatency ? 3 : 0)} ${unit}`);
        }

        // Função para animação contínua convergindo para a média
        function startContinuousAnimation(elementId, unit, isLatency = false) {
            const element = document.getElementById(`${elementId}-live`);
            const control = animationControl[elementId];
            
            if (!element || !control.running) return;
            
            // Tempo contínuo para animação
            const time = Date.now() * 0.001; // Tempo em segundos
            const history = valueHistory[elementId];
            
            let finalValue;
            
            if (history.length === 0) {
                // Sem dados ainda: movimento exploratório buscando valores
                const searchSpeed = isLatency ? 0.8 : 1.5; // Velocidade de busca
                const searchRange = isLatency ? 2 : 50; // Amplitude de busca
                const oscillation1 = Math.sin(time * searchSpeed) * searchRange * 0.5;
                const oscillation2 = Math.sin(time * searchSpeed * 1.3) * searchRange * 0.3;
                const oscillation3 = Math.sin(time * searchSpeed * 0.7) * searchRange * 0.2;
                
                finalValue = Math.max(0, oscillation1 + oscillation2 + oscillation3);
                
            } else {
                // Com dados: convergência suave para a média atual
                
                // Valor alvo é a média atual (calculada em updateLiveValue)
                const targetValue = control.targetValue;
                
                // Velocidade de convergência baseada no número de amostras
                // Mais amostras = convergência mais rápida (média mais estável)
                const samplesCount = history.length;
                const convergenceSpeed = Math.min(0.02 + (samplesCount * 0.001), 0.08);
                
                // Interpolação suave em direção à média
                const difference = targetValue - control.currentValue;
                control.currentValue += difference * convergenceSpeed;
                
                // Calcular oscilações baseadas na variação das amostras
                const variation = history.length > 1 ? 
                    Math.abs(Math.max(...history) - Math.min(...history)) : 
                    targetValue * 0.1;
                
                // Oscilações diminuem conforme mais amostras são coletadas
                const oscillationScale = Math.max(0.1, 1 - (samplesCount * 0.05));
                const oscillationRange = Math.min(variation * 0.05, targetValue * 0.03) * oscillationScale;
                
                // Oscilações suaves representando incerteza
                const wave1 = Math.sin(time * 1.2) * oscillationRange * 0.6;
                const wave2 = Math.sin(time * 1.8) * oscillationRange * 0.4;
                
                // Valor final = convergência + oscilações pequenas
                finalValue = control.currentValue + wave1 + wave2;
                
                // Garantir que não seja negativo
                finalValue = Math.max(0, finalValue);
            }
            
            // Formatar e exibir valor
            let displayValue;
            if (isLatency) {
                displayValue = `${finalValue.toFixed(3)} ${unit}`;
            } else {
                displayValue = `${Math.round(finalValue)} ${unit}`;
            }
            
            element.textContent = displayValue;
            element.classList.add('updating');
            
            // Continuar animação
            if (control.running) {
                control.animationId = requestAnimationFrame(() => {
                    startContinuousAnimation(elementId, unit, isLatency);
                });
            }
        }

        // Função para parar animação contínua IMEDIATAMENTE
        function stopContinuousAnimation(elementId) {
            const control = animationControl[elementId];
            if (control) {
                // Cancelar qualquer frame de animação pendente
                if (control.animationId) {
                    cancelAnimationFrame(control.animationId);
                    control.animationId = null;
                }
                
                // Parar completamente a animação
                control.running = false;
                control.currentValue = 0;
                control.targetValue = 0;
            }
            
            const element = document.getElementById(`${elementId}-live`);
            if (element) {
                element.classList.remove('updating');
            }
            
            // Log para confirmar que a animação foi parada
            console.log(`🛑 Animação contínua parada para ${elementId}`);
        }

        // Função para definir resultado final com parada imediata e exibição da média
        function setFinalResult(elementId, value, unit, isLatency = false) {
            const resultElement = document.getElementById(`${elementId}-result`);
            const liveElement = document.getElementById(`${elementId}-live`);
            
            if (!resultElement) return;
            
            // PARAR IMEDIATAMENTE toda animação contínua
            stopContinuousAnimation(elementId);
            
            // Garantir que o controle de animação está completamente parado
            const control = animationControl[elementId];
            if (control) {
                control.running = false;
                control.currentValue = 0;
                control.targetValue = 0;
                if (control.animationId) {
                    cancelAnimationFrame(control.animationId);
                    control.animationId = null;
                }
            }
            
            // Log final mostrando o comportamento do velocímetro
            const samplesCount = valueHistory[elementId].length;
            console.log(`🎯 ${elementId} finalizado: ${samplesCount} amostras coletadas, média final = ${value.toFixed(isLatency ? 3 : 0)} ${unit}`);
            
            // Mostrar IMEDIATAMENTE a média final (sem animação prévia)
            completeFinalResult(elementId, value, unit, isLatency);
        }

        // Função removida - não é mais necessária pois agora mostramos o resultado final imediatamente

        // Função para completar o resultado final
        function completeFinalResult(elementId, value, unit, isLatency = false) {
            const resultElement = document.getElementById(`${elementId}-result`);
            const liveElement = document.getElementById(`${elementId}-live`);
            
            // Formatar valor baseado no tipo
            let displayValue;
            if (isLatency) {
                displayValue = `${value.toFixed(3)} ${unit}`;
            } else {
                displayValue = `${Math.round(value)} ${unit}`;
            }
            
            // Garantir que a animação contínua pare completamente
            stopContinuousAnimation(elementId);
            
            // Ocultar elemento live IMEDIATAMENTE
            if (liveElement) {
                liveElement.style.display = 'none';
                liveElement.classList.remove('updating');
                liveElement.textContent = ''; // Limpar conteúdo
            }
            
            // Mostrar resultado final IMEDIATAMENTE
            resultElement.textContent = displayValue;
            resultElement.style.display = 'block';
            resultElement.classList.add('finalPulse');
            
            // Log para confirmar que a média foi calculada e exibida
            console.log(`📊 Resultado final do ${elementId}: ${displayValue} (média final de ${valueHistory[elementId].length} amostras)`);
            
            // Remover classe de animação após transição
            setTimeout(() => {
                resultElement.classList.remove('finalPulse');
            }, 600);
        }

        async function runTest(testName, testFunction) {
            console.log(`🔄 Executando teste de ${testName}...`);
            
            try {
                await testFunction();
            } catch (error) {
                console.error(`Erro no teste de ${testName}:`, error);
                const unit = testName === 'latency' ? 'ms' : 'Mbps';
                document.getElementById(`${testName}-result`).textContent = `Erro ${unit}`;
            }
        }

        // --- Test Implementations ---
        async function runDownloadTest() {
            // Iniciar velocímetro contínuo
            startSpeedometer('download', 'Mbps', false);
            
            const dataPoints = 12;
            const downloadData = [];
            const rawData = []; // Para análise estatística
            testConfig.chartLabels = Array.from({ length: dataPoints }, (_, i) => `${i + 1}`);
            
            // Intervalo entre testes para evitar sobrecarga
            const intervalMs = 800; // Aumentado para reduzir concorrência

            for (let i = 0; i < dataPoints; i++) {
                console.log(`📥 Download HTTP... ${i + 1}/${dataPoints}`);
                
                const speed = await testDownloadSpeed();
                rawData.push(speed); // Guarda resultado original (null ou número)
                
                if (speed !== null && speed > 0) {
                    downloadData.push(speed);
                    
                    // Atualizar valor ao vivo com animação
                    updateLiveValue('download', speed, 'Mbps');
                } else {
                    // Para o gráfico, usar interpolação ou último valor válido
                    const interpolatedValue = interpolateOrFallback(downloadData, i);
                    downloadData.push(interpolatedValue);
                }
                
                // Atualizar gráfico em tempo real
                updateMiniChart(downloadChart, testConfig.chartLabels.slice(0, i + 1), downloadData);
                
                // Aguardar intervalo apenas se não for o último ponto
                if (i < dataPoints - 1) {
                    await new Promise(res => setTimeout(res, intervalMs));
                }
            }
            
            // Análise estatística robusta
            const validSpeeds = rawData.filter(speed => speed !== null && speed > 0);
            const finalResult = calculateRobustStatistics(validSpeeds, dataPoints);
            
            // Definir resultado final com animação
            setFinalResult('download', finalResult, 'Mbps');
            
            // Log detalhado
            const successRate = `${validSpeeds.length}/${dataPoints}`;
            console.log(`📊 Download Final - Taxa de sucesso: ${successRate}, Resultado: ${Math.round(finalResult)} Mbps`);
        }

        async function runUploadTest() {
            // Iniciar velocímetro contínuo
            startSpeedometer('upload', 'Mbps', false);
            
            const dataPoints = 12;
            const uploadData = [];
            const rawData = []; // Para análise estatística
            
            // Intervalo entre testes para evitar sobrecarga
            const intervalMs = 1000; // Upload é mais lento, intervalo maior

            for (let i = 0; i < dataPoints; i++) {
                console.log(`📤 Upload HTTP... ${i + 1}/${dataPoints}`);
                
                const speed = await testUploadSpeed();
                rawData.push(speed); // Guarda resultado original (null ou número)
                
                if (speed !== null && speed > 0) {
                    uploadData.push(speed);
                    
                    // Atualizar valor ao vivo com animação
                    updateLiveValue('upload', speed, 'Mbps');
                } else {
                    // Para o gráfico, usar interpolação ou último valor válido
                    const interpolatedValue = interpolateOrFallback(uploadData, i);
                    uploadData.push(interpolatedValue);
                }
                
                // Atualizar gráfico em tempo real
                updateMiniChart(uploadChart, testConfig.chartLabels.slice(0, i + 1), uploadData);
                
                // Aguardar intervalo apenas se não for o último ponto
                if (i < dataPoints - 1) {
                    await new Promise(res => setTimeout(res, intervalMs));
                }
            }
            
            // Análise estatística robusta
            const validSpeeds = rawData.filter(speed => speed !== null && speed > 0);
            const finalResult = calculateRobustStatistics(validSpeeds, dataPoints);
            
            // Definir resultado final com animação
            setFinalResult('upload', finalResult, 'Mbps');
            
            // Log detalhado
            const successRate = `${validSpeeds.length}/${dataPoints}`;
            console.log(`📊 Upload Final - Taxa de sucesso: ${successRate}, Resultado: ${Math.round(finalResult)} Mbps`);
        }

        async function runLatencyTest() {
            // Iniciar velocímetro contínuo
            startSpeedometer('latency', 'ms', true);
            
            const dataPoints = 12; // 12 pings individuais
            const intervalMs = 500; // Delay entre pings
            const latencyData = [];
            
            // Executar 12 pings individuais em tempo real
            for (let i = 0; i < dataPoints; i++) {
                // Log de progresso no console
                console.log(`🏓 Latência... ${i + 1}/${dataPoints}`);
                
                // Executar ping individual
                const result = await latencyTest();
                
                if (result && result.success && result.latency !== null) {
                    latencyData.push(result.latency);
                    console.log(`✅ Ping ${i + 1}: ${result.latency.toFixed(3)}ms`);
                    
                    // Atualizar valor ao vivo com animação
                    updateLiveValue('latency', result.latency, 'ms', true);
                } else {
                    // Adicionar null para manter consistência
                    latencyData.push(null);
                    console.warn(`⚠️ Ping ${i + 1} falhou: ${result.error || 'Erro desconhecido'}`);
                }
                
                // Atualizar gráfico em tempo real
                updateMiniChart(latencyChart, testConfig.chartLabels.slice(0, i + 1), latencyData);
                
                // Aguardar intervalo apenas se não for o último ponto
                if (i < dataPoints - 1) {
                    await new Promise(res => setTimeout(res, intervalMs));
                }
            }
            
            // Calcular estatísticas dos valores válidos
            const validData = latencyData.filter(latency => latency !== null && latency > 0);
            
            if (validData.length > 0) {
                const avgLatency = validData.reduce((a, b) => a + b, 0) / validData.length;
                const sortedData = [...validData].sort((a, b) => a - b);
                const medianLatency = sortedData[Math.floor(sortedData.length / 2)];
                const minLatency = Math.min(...validData);
                const maxLatency = Math.max(...validData);
                
                // Definir resultado final com animação
                setFinalResult('latency', avgLatency, 'ms', true);
                
                // Log estatísticas completas
                const testType = validData.length > 0 && latencyData.find(d => d !== null) ? 
                    (latencyData.some((_, i) => validData[i] !== null) ? 'Ping Real' : 'HTTP') : 'Misto';
                const successRate = `${validData.length}/${dataPoints}`;
                console.log(`📊 ${testType} (${successRate}) - Média: ${avgLatency.toFixed(3)}ms, Mediana: ${medianLatency.toFixed(3)}ms, Min: ${minLatency.toFixed(3)}ms, Max: ${maxLatency.toFixed(3)}ms`);
            } else {
                // Caso todos os pings falhem
                const resultElement = document.getElementById('latency-result');
                const liveElement = document.getElementById('latency-live');
                
                resultElement.textContent = 'Sem resposta';
                if (liveElement) {
                    liveElement.textContent = 'falha na conexão';
                    liveElement.style.color = '#dc3545';
                }
                
                console.warn('❌ Todos os pings falharam');
            }
        }

        // --- Charting ---
        function initCharts() {
            // Mini chart options with scales
            const miniChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { 
                        enabled: true,
                        displayColors: false,
                        callbacks: {
                            title: function() {
                                return ''; // Remover título (índice)
                            },
                            label: function(context) {
                                // Personalizar label baseado no tipo de gráfico
                                const value = context.parsed.y;
                                if (value === null || value === undefined) {
                                    return 'Sem dados';
                                }
                                
                                // Detectar tipo do gráfico baseado na cor
                                const borderColor = context.dataset.borderColor;
                                if (borderColor === 'rgb(5,103,46)' || borderColor === 'rgb(0,66,13)') {
                                    // Gráfico de velocidade (download/upload) - sem casas decimais
                                    return `${Math.round(value)} Mbps`;
                                } else if (borderColor === 'rgb(255,210,0)') {
                                    // Gráfico de latência - com 3 casas decimais
                                    return `${value.toFixed(3)} ms`;
                                } else {
                                    // Fallback genérico para velocidade
                                    return `${Math.round(value)}`;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        display: true,
                        grid: { display: false },
                        ticks: { 
                            maxTicksLimit: 5,
                            font: { size: 9 }
                        }
                    },
                    y: { 
                        display: true,
                        beginAtZero: true,
                        grid: { display: true, color: 'rgba(0,0,0,0.1)' },
                        ticks: { 
                            maxTicksLimit: 4,
                            font: { size: 9 }
                        }
                    }
                },
                elements: {
                    point: { radius: 2, hoverRadius: 4 },
                    line: { tension: 0.4, borderWidth: 2 }
                }
            };

            // Initialize mini charts
            downloadChart = new Chart(document.getElementById('download-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        borderColor: 'rgb(5,103,46)',
                        backgroundColor: 'rgba(5,103,46,0.1)',
                        data: [],
                        fill: true
                    }]
                },
                options: miniChartOptions
            });

            uploadChart = new Chart(document.getElementById('upload-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        borderColor: 'rgb(0,66,13)',
                        backgroundColor: 'rgba(0,66,13,0.1)',
                        data: [],
                        fill: true
                    }]
                },
                options: miniChartOptions
            });

            latencyChart = new Chart(document.getElementById('latency-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        borderColor: 'rgb(255,210,0)',
                        backgroundColor: 'rgba(255,210,0,0.2)',
                        data: [],
                        fill: true
                    }]
                },
                options: miniChartOptions
            });
        }

        function updateMiniChart(chart, labels, data) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update('none');
        }

        // Função de depuração para testar manualmente a pilha dupla
        window.testDualStack = async function() {
            console.log('🔍 Testando pilha dupla manualmente...');
            try {
                const serverInfo = await fetchServerInfo();
                const currentStackTest = await fetch('/api/dual-stack-test');
                const currentStack = await currentStackTest.json();
                
                const results = await forceDualStackDetection(serverInfo, currentStack);
                console.log('🎯 Resultados:', results);
                
                ipv4Element.textContent = results.ipv4;
                ipv6Element.textContent = results.ipv6;
                updateConnectionBadges(results.ipv4, results.ipv6);
                
                return results;
            } catch (error) {
                console.error('❌ Erro no teste manual:', error);
                return null;
            }
        };

        // Função de teste de ping real individual - para validação
        window.testPingReal = async function() {
            console.log('🏓 Testando ping real individual...');
            
            try {
                const response = await fetch('/api/ping-real');
                const data = await response.json();
                
                if (data.success) {
                    console.log(`✅ Ping realizado com sucesso para ${data.clientIP}`);
                    console.log(`📊 Latências individuais: ${data.latencies.join(', ')}ms`);
                    console.log(`📈 Estatísticas:`);
                    console.log(`   - Média: ${data.statistics.average.toFixed(2)}ms`);
                    console.log(`   - Mediana: ${data.statistics.median.toFixed(2)}ms`);
                    console.log(`   - Min: ${data.statistics.min}ms`);
                    console.log(`   - Max: ${data.statistics.max}ms`);
                    console.log(`💡 Compare com: ping -c 5 ${data.clientIP}`);
                    
                    return data;
                } else {
                    console.error(`❌ Erro no ping: ${data.error}`);
                    console.log(`🔍 IP detectado: ${data.clientIP}`);
                    
                    return data;
                }
                
            } catch (error) {
                console.error('❌ Erro na requisição:', error);
                return null;
            }
        };

        // Função de teste de download HTTP direto - para validação
        window.testDownloadHTTP = async function() {
            console.log('🔄 Testando download HTTP direto robusto...');
            
            const result = await testDownloadSpeed();
            
            if (result !== null) {
                console.log(`✅ Download HTTP bem-sucedido: ${Math.round(result)} Mbps`);
                return { success: true, speedMbps: result };
            } else {
                console.error('❌ Download HTTP falhou após todas as tentativas');
                return { success: false, speedMbps: 0 };
            }
        };

        // Função de teste de upload HTTP direto - para validação
        window.testUploadHTTP = async function() {
            console.log('🔄 Testando upload HTTP direto robusto...');
            
            const result = await testUploadSpeed();
            
            if (result !== null) {
                console.log(`✅ Upload HTTP bem-sucedido: ${Math.round(result)} Mbps`);
                return { success: true, speedMbps: result };
            } else {
                console.error('❌ Upload HTTP falhou após todas as tentativas');
                return { success: false, speedMbps: 0 };
            }
        };

        // Função para copiar texto para clipboard
        window.copyToClipboard = function(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(function() {
                    showCopyFeedback('Comando copiado!');
                }, function(err) {
                    console.error('Erro ao copiar: ', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        };

        // Fallback para navegadores sem clipboard API
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyFeedback('Comando copiado!');
                } else {
                    showCopyFeedback('Erro ao copiar');
                }
            } catch (err) {
                console.error('Erro no fallback copy: ', err);
                showCopyFeedback('Erro ao copiar');
            }
            
            document.body.removeChild(textArea);
        }

        // Feedback visual para cópia
        function showCopyFeedback(message) {
            const feedback = document.createElement('div');
            feedback.className = 'position-fixed top-0 start-50 translate-middle-x alert alert-success alert-dismissible fade show';
            feedback.style.zIndex = '9999';
            feedback.style.marginTop = '20px';
            feedback.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            feedback.innerHTML = `
                <i class="fas fa-check me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(feedback);
            
            // Remover após 2 segundos
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 2000);
        }
    </script>
</body>
</html>