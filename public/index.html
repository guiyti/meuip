<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UFABC - Teste de Desempenho da Rede</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: rgb(5, 103, 46);
            --secondary-green: rgb(0, 66, 13);
            --highlight-yellow: rgb(255, 210, 0);
            --white: rgb(255, 255, 255);
            --light-gray: #f7f7f7;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header-banner {
            background-color: var(--primary-green);
            color: var(--white);
            padding: 0.7rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .site-logo img {
            max-width: 90px;
            height: auto;
        }

        .title-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .title-header h1 a {
            color: var(--white);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .title-header h1 a:hover {
            color: var(--highlight-yellow);
        }

        .description-header {
            font-size: 0.9rem;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 0;
        }

        .test-subtitle {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0.4rem 0;
            margin-top: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-container.testing-mode {
            justify-content: flex-start;
            padding-top: 2rem;
        }





        .results-section {
            width: 100%;
            max-width: 1000px;
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .results-section.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .results-header {
            background-color: var(--white);
            border-radius: 12px 12px 0 0;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .results-title {
            color: var(--primary-green);
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid var(--highlight-yellow);
            padding-bottom: 0.5rem;
        }

        #test-status {
            text-align: center;
            font-weight: 500;
            color: var(--secondary-green);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            background-color: var(--white);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .result-item {
            text-align: center;
            padding: 1rem;
            height: 240px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-right: 1px solid var(--medium-gray);
            background-color: var(--white);
            overflow: hidden;
        }

        .result-item:last-child {
            border-right: none;
        }

        .result-label {
            color: var(--dark-gray);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            white-space: nowrap;
        }

        .mini-chart-container {
            height: 120px;
            margin: 0.5rem 0;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .result-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-green);
            margin-top: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        
        @media (max-width: 1024px) {
            .control-bar {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                text-align: center;
            }
            

            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .result-item {
                border-right: none;
                border-bottom: 1px solid var(--medium-gray);
                height: 280px;
            }
            
            .result-item:last-child {
                border-bottom: none;
            }

            .mini-chart-container {
                height: 180px;
            }

            .title-header h1 {
                font-size: 1.4rem;
            }

            .description-header {
                font-size: 1rem;
            }
        }

        @media (max-width: 768px) {
            /* Banner compacto */
            .header-banner {
                padding: 0.5rem 0;
            }
            
            .site-logo {
                text-align: center;
                margin-bottom: 0.5rem;
            }
            
            .site-logo img {
                max-width: 60px;
            }
            
            .title-header {
                text-align: center;
            }

            .title-header h1 {
                font-size: 1rem;
                margin-bottom: 0.1rem;
            }

            .description-header {
                font-size: 0.75rem;
                margin-bottom: 0.1rem;
            }
            
            .test-subtitle {
                font-size: 0.7rem;
                margin-top: 0.2rem;
                padding: 0.2rem 0;
            }
            
            /* Layout mobile otimizado */
            
            .main-container {
                padding: 0.5rem;
            }

            .main-container.testing-mode {
                padding-top: 0.5rem;
            }

            /* Gr√°ficos grandes no mobile */
            .result-item {
                height: 350px;
                padding: 1rem;
            }

            .mini-chart-container {
                height: 220px;
            }

            .result-value {
                font-size: 1.6rem;
            }


        }

        @media (max-width: 480px) {
            /* Telas muito pequenas - gr√°ficos ainda maiores */
            .result-item {
                height: 400px;
                padding: 0.8rem;
            }

            .mini-chart-container {
                height: 260px;
            }


        }

        /* Layout minimalista redesenhado */
        .control-bar {
            position: relative;
            background: #ffffff;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            width: 100%;
            max-width: 1000px;
        }
        
        .connection-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0.8;
        }
        
        .connection-badge .badge-text {
            margin-left: 0.25rem;
        }
        
        .badge-direct {
            background: rgba(5, 155, 46, 0.1);
            color: #059b2e;
            border: 1px solid rgba(5, 155, 46, 0.2);
        }
        
        .badge-vpn {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .connection-status-icon {
            font-size: 0.75rem;
        }
        
        .ip-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 0;
        }
        
        .ip-block {
            flex-shrink: 0;
        }
        
        .ipv4-block {
            min-width: 160px;
            max-width: 180px;
        }
        
        .ipv6-block {
            flex: 1;
            min-width: 280px;
            max-width: 420px;
        }
        
        .ip-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .ip-value {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.875rem;
            font-weight: 500;
            color: #212529;
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            word-break: break-all;
            line-height: 1.3;
            min-height: 48px;
            display: flex;
            align-items: center;
        }
        
        .ipv6-value {
            letter-spacing: 0.02em;
            word-spacing: 0.1em;
        }
        
        .action-controls {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-shrink: 0;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .test-button:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        .test-button:disabled {
            background: #6c757d;
            color: #ffffff;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .test-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .test-button .fa-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-button {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-button:hover {
            background: #e9ecef;
            color: #495057;
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .control-bar {
                padding: 1.5rem;
            }
            
            .ip-container {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .ipv4-block,
            .ipv6-block {
                min-width: unset;
                max-width: unset;
                flex: unset;
            }
            
            .action-controls {
                flex-direction: row;
                justify-content: center;
                gap: 1rem;
                margin-top: 1rem;
            }
            
            .test-button {
                flex: 1;
                justify-content: center;
            }
        }
        
        /* Melhorias para o modal */
        .modal-body code {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            display: block;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .accordion-button {
            font-weight: 500;
        }
        
        .accordion-body h6 {
            color: #495057;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .accordion-body h6:first-child {
            margin-top: 0;
        }
        
        .accordion-body p {
            margin-bottom: 0.5rem;
        }
        
        .accordion-body strong {
            color: #007bff;
        }
    </style>
</head>
<body>
    <header class="header-banner">
        <div class="container">
            <div class="row w-100">
                <div class="col-12 col-md-2 site-logo py-3">
                    <a href="https://ufabc.edu.br/">
                        <img class="img-fluid" alt="Logo Universidade Federal do ABC - UFABC" src="https://nti.ufabc.edu.br/wp-content/themes/NTI-theme/images/logo2.png">
                    </a>
                </div>
                <div class="col-sm-12 col-md-10">
                    <div class="row">
                        <div class="col-sm-12 pt-2">
                            <div class="row">
                                <div class="col-12">
                                    <div class="title-header">
                                        <h1><a href="https://nti.ufabc.edu.br/">N√∫cleo de Tecnologia da Informa√ß√£o</a></h1>
                                        <h2 class="description-header">Universidade Federal do ABC</h2>
                                    </div>
                                    <div class="test-subtitle">
                                        <i class="fas fa-network-wired"></i> Sistema de Teste de Velocidade da UFABCnet
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container" id="main-container">
        <div class="control-bar" id="control-bar">
            <div class="connection-badge badge-direct" id="connection-badge">
                <i class="fas fa-spinner fa-spin connection-status-icon"></i>
                <span class="badge-text">detectando...</span>
            </div>
            
            <div class="ip-container">
                <div class="ip-block ipv4-block">
                    <label class="ip-label">IPv4</label>
                    <div class="ip-value" id="ipv4">Carregando...</div>
                </div>
                <div class="ip-block ipv6-block">
                    <label class="ip-label">IPv6</label>
                    <div class="ip-value ipv6-value" id="ipv6">Carregando...</div>
                </div>
                <div class="action-controls">
                    <button id="start-test-btn" class="test-button">
                        <i class="fas fa-play"></i>
                        Testar
                    </button>
                    <button id="explain-btn" class="info-button" type="button" data-bs-toggle="modal" data-bs-target="#explainModal" title="Como funciona o teste?">
                        <i class="fas fa-info"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="results-section" id="results-section">
            <div class="results-header">
                <div class="results-title">Resultados</div>
            </div>
            <div class="results-grid">
                <div class="result-item">
                    <div class="result-label">Download</div>
                    <div class="mini-chart-container">
                        <canvas id="download-chart"></canvas>
                    </div>
                    <div class="result-value" id="download-result">-- Mbps</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Upload</div>
                    <div class="mini-chart-container">
                        <canvas id="upload-chart"></canvas>
                    </div>
                    <div class="result-value" id="upload-result">-- Mbps</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Lat√™ncia</div>
                    <div class="mini-chart-container">
                        <canvas id="latency-chart"></canvas>
                    </div>
                    <div class="result-value" id="latency-result">-- ms</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de explica√ß√£o -->
    <div class="modal fade" id="explainModal" tabindex="-1" aria-labelledby="explainModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="explainModalLabel">
                        <i class="fas fa-terminal text-primary"></i> Como funciona o teste?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="explanationAccordion">
                        <!-- Vis√£o Geral -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOverview">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOverview">
                                    <i class="fas fa-info-circle text-info me-2"></i>Vis√£o Geral
                                </button>
                            </h2>
                            <div id="collapseOverview" class="accordion-collapse collapse show" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <p>Os testes de velocidade s√£o realizados atrav√©s de <strong>HTTP direto</strong> entre seu navegador e o servidor para medir precisamente a performance da sua conex√£o de rede.</p>
                                    <p>Todos os testes s√£o executados no <strong>cliente</strong> (seu navegador) medindo o tempo real de transfer√™ncia entre sua m√°quina e o servidor.</p>
                                    <p>Esta abordagem testa a velocidade real da sua conex√£o, n√£o a velocidade do servidor ou loopback local.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Teste de Lat√™ncia -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingLatency">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLatency">
                                    <i class="fas fa-clock text-warning me-2"></i>Teste de Lat√™ncia (Ping)
                                </button>
                            </h2>
                            <div id="collapseLatency" class="accordion-collapse collapse" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <h6>Comando utilizado:</h6>
                                    <code>ping -c 1 meuip.ufabc.int.br</code>
                                    
                                    <h6 class="mt-3">Processo:</h6>
                                    <ol>
                                        <li>Executa 12 pings individuais (1 pacote cada)</li>
                                        <li>Intervalo de 500ms entre cada ping</li>
                                        <li>Extrai o tempo de resposta em milissegundos</li>
                                        <li>Apresenta cada resultado imediatamente</li>
                                    </ol>
                                    
                                    <h6 class="mt-3">Resultado exemplo:</h6>
                                    <p><code>64 bytes from meuip.ufabc.int.br: icmp_seq=1 time=12.4 ms</code></p>
                                    <p>O tempo medido √© o <strong>round-trip time (RTT)</strong> - o tempo total da viagem de ida e volta.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Teste de Download -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingDownload">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDownload">
                                    <i class="fas fa-download text-success me-2"></i>Teste de Download
                                </button>
                            </h2>
                            <div id="collapseDownload" class="accordion-collapse collapse" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <h6>M√©todo utilizado:</h6>
                                    <code>fetch('/testfile') + performance.now()</code>
                                    
                                    <h6 class="mt-3">Processo:</h6>
                                    <ol>
                                        <li>Navegador baixa arquivo de teste de 1MB do servidor</li>
                                        <li>Mede tempo usando performance.now() (alta precis√£o)</li>
                                        <li>Calcula velocidade: (bytes √ó 8) / (tempo √ó 1.000.000)</li>
                                        <li>Testa velocidade real cliente-servidor</li>
                                    </ol>
                                    
                                    <h6 class="mt-3">Exemplo de c√°lculo:</h6>
                                    <p><code>1.048.576 bytes em 0.125 segundos</code></p>
                                    <p>Velocidade: (1.048.576 √ó 8) / (0.125 √ó 1.000.000)</p>
                                    <p>Resultado: <strong>67.1 Mbps</strong></p>
                                </div>
                            </div>
                        </div>

                        <!-- Teste de Upload -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingUpload">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpload">
                                    <i class="fas fa-upload text-primary me-2"></i>Teste de Upload
                                </button>
                            </h2>
                            <div id="collapseUpload" class="accordion-collapse collapse" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <h6>M√©todo utilizado:</h6>
                                    <code>fetch('/upload', {method: 'POST', body: testData}) + performance.now()</code>
                                    
                                    <h6 class="mt-3">Processo:</h6>
                                    <ol>
                                        <li>JavaScript cria dados de teste de 1MB (Uint8Array)</li>
                                        <li>Navegador envia dados via POST para servidor</li>
                                        <li>Mede tempo usando performance.now() (alta precis√£o)</li>
                                        <li>Testa velocidade real cliente-servidor</li>
                                    </ol>
                                    
                                    <h6 class="mt-3">Exemplo de c√°lculo:</h6>
                                    <p><code>1.048.576 bytes em 0.156 segundos</code></p>
                                    <p>Velocidade: (1.048.576 √ó 8) / (0.156 √ó 1.000.000)</p>
                                    <p>Resultado: <strong>53.7 Mbps</strong></p>
                                </div>
                            </div>
                        </div>

                        <!-- Usu√°rios Avan√ßados -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingAdvanced">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                                    <i class="fas fa-terminal text-dark me-2"></i>Para Usu√°rios Avan√ßados
                                </button>
                            </h2>
                            <div id="collapseAdvanced" class="accordion-collapse collapse" data-bs-parent="#explanationAccordion">
                                <div class="accordion-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Para especialistas em rede:</strong> Use os comandos abaixo para validar e comparar os resultados da interface web.
                                    </div>

                                    <h6>üîΩ Teste de Download via Curl:</h6>
                                    <div class="bg-dark text-light p-3 rounded mb-3">
                                        <code class="text-success">curl -s -o /dev/null -w "%{time_total},%{size_download},%{speed_download}" http://meuip.ufabc.int.br/testfile</code>
                                    </div>
                                    <p><strong>Sa√≠da esperada:</strong> <code>0.125,1048576,67108864</code></p>
                                    <p><strong>C√°lculo:</strong> 67.108.864 bytes/s = <strong>67.1 Mbps</strong></p>

                                    <h6 class="mt-4">üîº Teste de Upload via Curl:</h6>
                                    <div class="bg-dark text-light p-3 rounded mb-3">
                                        <code class="text-success">dd if=/dev/zero bs=1024 count=1024 2>/dev/null | curl -s -X POST --data-binary @- -w "%{time_total},%{size_upload},%{speed_upload}" http://meuip.ufabc.int.br/upload</code>
                                    </div>
                                    <p><strong>Sa√≠da esperada:</strong> <code>0.156,1048576,53687091</code></p>
                                    <p><strong>C√°lculo:</strong> 53.687.091 bytes/s = <strong>53.7 Mbps</strong></p>

                                    <h6 class="mt-4">üèì Teste de Lat√™ncia via Ping:</h6>
                                    <div class="bg-dark text-light p-3 rounded mb-3">
                                        <code class="text-success">ping -c 12 meuip.ufabc.int.br</code>
                                    </div>
                                    <p><strong>Resultado:</strong> M√©dia dos tempos RTT</p>

                                    <h6 class="mt-4">üìä Script Profissional de Valida√ß√£o:</h6>
                                    <div class="alert alert-success">
                                        <i class="fas fa-download me-2"></i>
                                        <strong>Download do Script:</strong> 
                                        <a href="/validate_speed.sh" class="alert-link" download>validate_speed.sh</a>
                                    </div>
                                    
                                    <h6 class="mt-3">üöÄ Como usar o script:</h6>
                                    <div class="bg-dark text-light p-3 rounded mb-3">
<pre class="text-light mb-0"># Baixar, executar e remover automaticamente
curl -O http://meuip.ufabc.int.br/validate_speed.sh && chmod +x validate_speed.sh && ./validate_speed.sh

# Teste customizado (20 medi√ß√µes)
curl -O http://meuip.ufabc.int.br/validate_speed.sh && chmod +x validate_speed.sh && ./validate_speed.sh 20</pre>
                                    </div>
                                    
                                    <div class="alert alert-info small">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Auto-Delete:</strong> O script se remove automaticamente ap√≥s a execu√ß√£o para garantir que sempre seja baixada a vers√£o mais atualizada.
                                    </div>

                                    <h6 class="mt-3">üìã Funcionalidades do Script:</h6>
                                    <ul class="small">
                                        <li><strong>M√∫ltiplas medi√ß√µes:</strong> Executa 12 testes por padr√£o (configur√°vel)</li>
                                        <li><strong>An√°lise estat√≠stica:</strong> Calcula mediana (igual √† interface web)</li>
                                        <li><strong>Retry autom√°tico:</strong> Tenta novamente em caso de falha</li>
                                        <li><strong>Cache-busting:</strong> Evita cache com timestamps √∫nicos</li>
                                        <li><strong>Timeout:</strong> Evita travamento em conex√µes lentas</li>
                                        <li><strong>Auto-delete:</strong> Remove-se ap√≥s execu√ß√£o (sempre vers√£o atualizada)</li>
                                        <li><strong>Progress visual:</strong> Mostra progresso colorido</li>
                                    </ul>

                                    <h6 class="mt-3">üìù Exemplo de Sa√≠da:</h6>
                                    <div class="bg-dark text-light p-3 rounded mb-3 small">
<pre class="text-light mb-0">===============================================
  Valida√ß√£o de Velocidade UFABCnet - v1.0
===============================================
Host: meuip.ufabc.int.br
Testes por m√©trica: 12

üîΩ Iniciando teste de Download...
   Teste 1/12... ‚úì 67.234 Mbps
   Teste 2/12... ‚úì 65.891 Mbps
   ...
   üìä Download - Mediana: 66.542 Mbps (Taxa de sucesso: 12/12)

üîº Iniciando teste de Upload...
   Teste 1/12... ‚úì 53.876 Mbps
   ...
   üìä Upload - Mediana: 52.341 Mbps (Taxa de sucesso: 11/12)

üèì Iniciando teste de Lat√™ncia...
   üìä Lat√™ncia - Mediana: 12.4 ms (Taxa de sucesso: 12/12)

===============================================
              RELAT√ìRIO FINAL
===============================================
üì• Download:  66.542 Mbps
üì§ Upload:    52.341 Mbps
üèì Lat√™ncia:  12.4 ms

üßπ Limpando arquivo tempor√°rio...
‚úÖ Script removido com sucesso
üí° Para executar novamente, baixe a vers√£o atualizada:
   curl -O http://meuip.ufabc.int.br/validate_speed.sh && chmod +x validate_speed.sh && ./validate_speed.sh</pre>
                                    </div>

                                    <h6 class="mt-4">‚ö†Ô∏è Diferen√ßas Esperadas:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="small text-muted">üåê INTERFACE WEB:</h6>
                                            <ul class="small">
                                                <li><strong>M√©todo:</strong> HTTP fetch() via JavaScript</li>
                                                <li><strong>Timer:</strong> performance.now() (alta precis√£o)</li>
                                                <li><strong>Headers:</strong> Navegador + User-Agent</li>
                                                <li><strong>Conex√£o:</strong> HTTP/1.1 keep-alive</li>
                                                <li><strong>Retry:</strong> 3 tentativas autom√°ticas</li>
                                                <li><strong>Estat√≠stica:</strong> Mediana de 12 testes</li>
                                                <li><strong>Cache:</strong> Cache-busting for√ßado</li>
                                                <li><strong>Overhead:</strong> Engine JavaScript + DOM</li>
                                            </ul>
                                        </div>
                                                                                 <div class="col-md-6">
                                             <h6 class="small text-muted">üíª CURL/SCRIPT:</h6>
                                             <ul class="small">
                                                 <li><strong>M√©todo:</strong> Curl nativo (C/libcurl)</li>
                                                 <li><strong>Timer:</strong> Timer interno do curl</li>
                                                 <li><strong>Headers:</strong> M√≠nimos (Host, User-Agent)</li>
                                                 <li><strong>Conex√£o:</strong> HTTP/1.1 nova conex√£o</li>
                                                 <li><strong>Timeout:</strong> 15s (download) / 30s (upload)</li>
                                                 <li><strong>Estat√≠stica:</strong> Mediana de N testes</li>
                                                 <li><strong>Cache:</strong> Cache-busting via timestamp</li>
                                                 <li><strong>Overhead:</strong> M√≠nimo (nativo)</li>
                                             </ul>
                                         </div>
                                    </div>

                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Diferen√ßas T√≠picas:</strong>
                                        <ul class="mb-0 small">
                                            <li><strong>¬±5-15%:</strong> Varia√ß√£o normal entre m√©todos</li>
                                            <li><strong>Download:</strong> Curl pode ser 5-10% mais r√°pido (menos overhead)</li>
                                            <li><strong>Upload:</strong> Interface web pode ser mais r√°pida (keep-alive)</li>
                                            <li><strong>Lat√™ncia:</strong> Ping sempre mais preciso que HTTP</li>
                                            <li><strong>Primeira execu√ß√£o:</strong> Curl pode ser mais lento (cold start)</li>
                                            <li><strong>M√∫ltiplas execu√ß√µes:</strong> Resultados devem convergir</li>
                                        </ul>
                                    </div>

                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Valida√ß√£o Profissional:</strong> Execute o script m√∫ltiplas vezes e compare as medianas. Diferen√ßas >20% podem indicar problemas de rede ou configura√ß√£o.
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import {
            fetchServerInfo,
            testClientIPv4,
            testClientIPv6,
            testDownloadSpeed,
            testUploadSpeed,
            latencyTest
        } from '/modules/network-tests.js';

        // --- DOM Elements ---
        const startTestBtn = document.getElementById('start-test-btn');
        const resultsSection = document.getElementById('results-section');
        const mainContainer = document.getElementById('main-container');
        
        const ipv4Element = document.getElementById('ipv4');
        const ipv6Element = document.getElementById('ipv6');
        const connectionBadge = document.getElementById('connection-badge');

        let downloadChart, uploadChart, latencyChart;

        // --- Test Configuration ---
        const testConfig = {
            location: '',
            results: { download: null, upload: null, latency: null },
            chartLabels: [],
        };

        // --- Fun√ß√µes Auxiliares Robustas ---
        
        // Interpola√ß√£o ou fallback para valores faltantes
        function interpolateOrFallback(validData, currentIndex) {
            // Se n√£o h√° dados v√°lidos ainda, usar 0
            if (validData.length === 0) {
                return 0;
            }
            
            // Se h√° apenas um valor, usar ele
            if (validData.length === 1) {
                return validData[0];
            }
            
            // Se h√° m√∫ltiplos valores, usar interpola√ß√£o linear simples
            // ou a m√©dia dos √∫ltimos 2 valores
            const recentValues = validData.slice(-2);
            return recentValues.reduce((a, b) => a + b, 0) / recentValues.length;
        }
        
        // An√°lise estat√≠stica robusta com detec√ß√£o de outliers
        function calculateRobustStatistics(validSpeeds, totalTests) {
            // Se n√£o h√° dados v√°lidos, retornar 0
            if (validSpeeds.length === 0) {
                console.warn('‚ö†Ô∏è Nenhum teste v√°lido, retornando 0');
                return 0;
            }
            
            // Se h√° poucos dados (< 30% de sucesso), usar m√©dia simples
            if (validSpeeds.length < totalTests * 0.3) {
                const average = validSpeeds.reduce((a, b) => a + b, 0) / validSpeeds.length;
                console.warn(`‚ö†Ô∏è Poucos dados v√°lidos (${validSpeeds.length}/${totalTests}), usando m√©dia: ${average.toFixed(3)} Mbps`);
                return average;
            }
            
            // Ordenar para calcular mediana e quartis
            const sorted = [...validSpeeds].sort((a, b) => a - b);
            
            // Calcular quartis para detec√ß√£o de outliers
            const q1Index = Math.floor(sorted.length * 0.25);
            const q3Index = Math.floor(sorted.length * 0.75);
            const q1 = sorted[q1Index];
            const q3 = sorted[q3Index];
            const iqr = q3 - q1;
            
            // Filtrar outliers (valores fora de 1.5 * IQR)
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            const filteredSpeeds = sorted.filter(speed => speed >= lowerBound && speed <= upperBound);
            
            // Se removeu muitos outliers, usar dados originais
            if (filteredSpeeds.length < validSpeeds.length * 0.5) {
                console.log(`üìä Muitos outliers detectados, usando dados originais`);
                const median = sorted[Math.floor(sorted.length / 2)];
                return median;
            }
            
            // Usar mediana dos dados filtrados (mais robusta que m√©dia)
            const medianFiltered = filteredSpeeds[Math.floor(filteredSpeeds.length / 2)];
            
            console.log(`üìä Estat√≠sticas - Dados v√°lidos: ${validSpeeds.length}/${totalTests}, Outliers removidos: ${validSpeeds.length - filteredSpeeds.length}, Resultado: ${medianFiltered.toFixed(3)} Mbps`);
            
            return medianFiltered;
        }



        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialInfo();
            startTestBtn.addEventListener('click', startDiagnostic);
            initCharts();
        });

        // --- Core Functions ---
        async function loadInitialInfo() {
            try {
                const serverInfo = await fetchServerInfo();
                console.log('Server info:', serverInfo);
                
                // Testar pilha dupla de forma paralela e independente
                console.log('üîç Iniciando teste de pilha dupla...');
                
                // Sempre usar configura√ß√µes robustas de produ√ß√£o
                console.log('üåç Configura√ß√µes de produ√ß√£o sempre aplicadas para m√°xima robustez');
                
                // Teste 1: Verificar qual stack est√° sendo usado atualmente
                const currentStackTest = await fetch('/api/dual-stack-test');
                const currentStack = await currentStackTest.json();
                console.log('üìä Stack atual detectado:', currentStack);
                
                // For√ßar detec√ß√£o de ambos os IPs atrav√©s de m√∫ltiplas estrat√©gias
                const dualStackResults = await forceDualStackDetection(serverInfo, currentStack);
                
                // Atualizar interface com os resultados
                ipv4Element.textContent = dualStackResults.ipv4;
                ipv6Element.textContent = dualStackResults.ipv6;
                
                // Determinar tipo de conex√£o baseado nos IPs detectados
                updateConnectionBadges(dualStackResults.ipv4, dualStackResults.ipv6);
                
                console.log('üéØ Pilha dupla detectada - IPv4:', dualStackResults.ipv4, '| IPv6:', dualStackResults.ipv6);

            } catch (error) {
                console.error('‚ùå Erro ao carregar informa√ß√µes iniciais:', error);
                ipv4Element.textContent = 'Erro';
                ipv6Element.textContent = 'Erro';
            }
        }

        // Fun√ß√£o para for√ßar detec√ß√£o de pilha dupla
        async function forceDualStackDetection(serverInfo, currentStack) {
            let ipv4Result = 'N√£o detectado';
            let ipv6Result = 'N√£o detectado';
                
            // Estrat√©gia 1: Endpoint padr√£o (melhor para detec√ß√£o geral)
            try {
                console.log('üîÑ Testando endpoint padr√£o...');
                const fallbackResponse = await fetch('/api/client-ips');
                const fallbackData = await fallbackResponse.json();
                
                if (fallbackData.ipv4 && fallbackData.ipv4 !== 'N√£o detectado') {
                    ipv4Result = fallbackData.ipv4;
                    console.log('‚úÖ IPv4 detectado via endpoint padr√£o:', ipv4Result);
                }
                
                if (fallbackData.ipv6 && fallbackData.ipv6 !== 'N√£o detectado') {
                    ipv6Result = fallbackData.ipv6;
                    console.log('‚úÖ IPv6 detectado via endpoint padr√£o:', ipv6Result);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Endpoint padr√£o falhou:', error.message);
            }

            // Estrat√©gia 2: Tentar IPv4 espec√≠fico (se dispon√≠vel)
            if (serverInfo.ipv4) {
                try {
                    console.log(`üåê Testando IPv4 via ${serverInfo.ipv4}...`);
                    const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
                    const ipv4Response = await fetch(`http://${serverInfo.ipv4}:${port}/api/client-ips`, {
                        signal: AbortSignal.timeout(8000) // 8 segundos timeout
                    });
                    const ipv4Data = await ipv4Response.json();
                    if (ipv4Data.ipv4 && ipv4Data.ipv4 !== 'N√£o detectado') {
                        ipv4Result = ipv4Data.ipv4;
                        console.log('‚úÖ IPv4 confirmado via IP espec√≠fico:', ipv4Result);
                    }
                    if (ipv4Data.ipv6 && ipv4Data.ipv6 !== 'N√£o detectado' && ipv6Result === 'N√£o detectado') {
                        ipv6Result = ipv4Data.ipv6;
                        console.log('‚úÖ IPv6 detectado via IPv4 espec√≠fico:', ipv6Result);
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Teste IPv4 espec√≠fico falhou:', error.message);
                }
            }
                
            // Estrat√©gia 3: Tentar IPv6 espec√≠fico (se dispon√≠vel)
            if (serverInfo.ipv6) {
                try {
                    console.log(`üåç Testando IPv6 via [${serverInfo.ipv6}]...`);
                    const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
                    const ipv6Response = await fetch(`http://[${serverInfo.ipv6}]:${port}/api/client-ips`, {
                        signal: AbortSignal.timeout(8000) // 8 segundos timeout
                    });
                    const ipv6Data = await ipv6Response.json();
                    if (ipv6Data.ipv6 && ipv6Data.ipv6 !== 'N√£o detectado') {
                        ipv6Result = ipv6Data.ipv6;
                        console.log('‚úÖ IPv6 confirmado via IP espec√≠fico:', ipv6Result);
                    }
                    if (ipv6Data.ipv4 && ipv6Data.ipv4 !== 'N√£o detectado' && ipv4Result === 'N√£o detectado') {
                        ipv4Result = ipv6Data.ipv4;
                        console.log('‚úÖ IPv4 detectado via IPv6 espec√≠fico:', ipv4Result);
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Teste IPv6 espec√≠fico falhou:', error.message);
                }
            }
                
            // Estrat√©gia 4: Fallback usando currentStack
            if (ipv4Result === 'N√£o detectado' && currentStack.clientIP) {
                const cleanIP = currentStack.clientIP.replace(/^::ffff:/, '');
                if (cleanIP.includes('.') && cleanIP !== '127.0.0.1') {
                    ipv4Result = cleanIP;
                    console.log('üîÑ IPv4 extra√≠do do currentStack:', ipv4Result);
                }
            }
            
            if (ipv6Result === 'N√£o detectado' && currentStack.clientIP) {
                const cleanIP = currentStack.clientIP;
                if (cleanIP.includes(':') && !cleanIP.startsWith('fe80:') && cleanIP !== '::1' && !cleanIP.includes('::ffff:')) {
                    ipv6Result = cleanIP;
                    console.log('üîÑ IPv6 extra√≠do do currentStack:', ipv6Result);
                }
            }
            
            return { ipv4: ipv4Result, ipv6: ipv6Result };
        }

        function updateConnectionBadges(ipv4, ipv6) {
            // Verificar se √© VPN
            let isVpn = false;
            let networkType = 'rede interna';
            
            if (ipv4 && ipv4.includes('172.17.4.')) {
                isVpn = true;
                networkType = 'VPN institucional';
            }
            
            // Criar badge moderno com √≠cone
            const icon = isVpn ? 
                '<i class="fas fa-shield-alt connection-status-icon"></i>' : 
                '<i class="fas fa-network-wired connection-status-icon"></i>';
            
            connectionBadge.innerHTML = `${icon}${networkType}`;
            connectionBadge.className = `connection-badge ${isVpn ? 'badge-vpn' : 'badge-direct'}`;
        }

        async function startDiagnostic() {
            // Determinar tipo de conex√£o para logs
            const isVpn = connectionBadge.classList.contains('badge-vpn');
            const location = isVpn ? 'VPN Institucional' : 'Rede Interna';
            
            testConfig.location = location;

            // Anima√ß√µes de layout
            mainContainer.classList.add('testing-mode');
            resultsSection.classList.add('visible');

            startTestBtn.disabled = true;
            startTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
            
            resetUI();

            console.log(`üöÄ Iniciando diagn√≥stico via Curl - Localiza√ß√£o: ${location}`);

            // Executar testes via Curl
            await runTest('download', runDownloadTest);
            await runTest('upload', runUploadTest);
            await runTest('latency', runLatencyTest);


            startTestBtn.disabled = false;
            startTestBtn.innerHTML = '<i class="fas fa-play"></i> Testar';
        }


        
        function resetUI() {
            // Reset results
            document.getElementById('download-result').textContent = '-- Mbps';
            document.getElementById('upload-result').textContent = '-- Mbps';
            document.getElementById('latency-result').textContent = '-- ms';
            
            // Reset charts
            testConfig.chartLabels = [];
            resetChart(downloadChart);
            resetChart(uploadChart);
            resetChart(latencyChart);
        }

        function resetChart(chart) {
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.update('none');
        }

        async function runTest(testName, testFunction) {
            console.log(`üîÑ Executando teste de ${testName}...`);
            
            try {
                await testFunction();
            } catch (error) {
                console.error(`Erro no teste de ${testName}:`, error);
                const unit = testName === 'latency' ? 'ms' : 'Mbps';
                document.getElementById(`${testName}-result`).textContent = `Erro ${unit}`;
            }
        }

        // --- Test Implementations ---
        async function runDownloadTest() {
            const dataPoints = 12;
            const downloadData = [];
            const rawData = []; // Para an√°lise estat√≠stica
            testConfig.chartLabels = Array.from({ length: dataPoints }, (_, i) => `${i + 1}`);
            
            // Intervalo entre testes para evitar sobrecarga
            const intervalMs = 800; // Aumentado para reduzir concorr√™ncia

            for (let i = 0; i < dataPoints; i++) {
                console.log(`üì• Download HTTP... ${i + 1}/${dataPoints}`);
                
                const speed = await testDownloadSpeed();
                rawData.push(speed); // Guarda resultado original (null ou n√∫mero)
                
                if (speed !== null && speed > 0) {
                    downloadData.push(speed);
                } else {
                    // Para o gr√°fico, usar interpola√ß√£o ou √∫ltimo valor v√°lido
                    const interpolatedValue = interpolateOrFallback(downloadData, i);
                    downloadData.push(interpolatedValue);
                }
                
                // Atualizar gr√°fico em tempo real
                updateMiniChart(downloadChart, testConfig.chartLabels.slice(0, i + 1), downloadData);
                
                // Aguardar intervalo apenas se n√£o for o √∫ltimo ponto
                if (i < dataPoints - 1) {
                    await new Promise(res => setTimeout(res, intervalMs));
                }
            }
            
            // An√°lise estat√≠stica robusta
            const validSpeeds = rawData.filter(speed => speed !== null && speed > 0);
            const finalResult = calculateRobustStatistics(validSpeeds, dataPoints);
            
            document.getElementById('download-result').textContent = `${finalResult.toFixed(3)} Mbps`;
            
            // Log detalhado
            const successRate = `${validSpeeds.length}/${dataPoints}`;
            console.log(`üìä Download Final - Taxa de sucesso: ${successRate}, Resultado: ${finalResult.toFixed(3)} Mbps`);
        }

        async function runUploadTest() {
            const dataPoints = 12;
            const uploadData = [];
            const rawData = []; // Para an√°lise estat√≠stica
            
            // Intervalo entre testes para evitar sobrecarga
            const intervalMs = 1000; // Upload √© mais lento, intervalo maior

            for (let i = 0; i < dataPoints; i++) {
                console.log(`üì§ Upload HTTP... ${i + 1}/${dataPoints}`);
                
                const speed = await testUploadSpeed();
                rawData.push(speed); // Guarda resultado original (null ou n√∫mero)
                
                if (speed !== null && speed > 0) {
                    uploadData.push(speed);
                } else {
                    // Para o gr√°fico, usar interpola√ß√£o ou √∫ltimo valor v√°lido
                    const interpolatedValue = interpolateOrFallback(uploadData, i);
                    uploadData.push(interpolatedValue);
                }
                
                // Atualizar gr√°fico em tempo real
                updateMiniChart(uploadChart, testConfig.chartLabels.slice(0, i + 1), uploadData);
                
                // Aguardar intervalo apenas se n√£o for o √∫ltimo ponto
                if (i < dataPoints - 1) {
                    await new Promise(res => setTimeout(res, intervalMs));
                }
            }
            
            // An√°lise estat√≠stica robusta
            const validSpeeds = rawData.filter(speed => speed !== null && speed > 0);
            const finalResult = calculateRobustStatistics(validSpeeds, dataPoints);
            
            document.getElementById('upload-result').textContent = `${finalResult.toFixed(3)} Mbps`;
            
            // Log detalhado
            const successRate = `${validSpeeds.length}/${dataPoints}`;
            console.log(`üìä Upload Final - Taxa de sucesso: ${successRate}, Resultado: ${finalResult.toFixed(3)} Mbps`);
        }

        async function runLatencyTest() {
            const dataPoints = 12; // 12 pings individuais
            const intervalMs = 500; // Delay entre pings
            const latencyData = [];
            
            // Executar 12 pings individuais em tempo real
            for (let i = 0; i < dataPoints; i++) {
                // Log de progresso no console
                console.log(`üèì Lat√™ncia... ${i + 1}/${dataPoints}`);
                
                // Executar ping individual
                const result = await latencyTest();
                
                if (result && result.success && result.latency !== null) {
                    latencyData.push(result.latency);
                    console.log(`‚úÖ Ping ${i + 1}: ${result.latency.toFixed(3)}ms`);
                } else {
                    // Adicionar null para manter consist√™ncia
                    latencyData.push(null);
                    console.warn(`‚ö†Ô∏è Ping ${i + 1} falhou: ${result.error || 'Erro desconhecido'}`);
                }
                
                // Atualizar gr√°fico em tempo real
                updateMiniChart(latencyChart, testConfig.chartLabels.slice(0, i + 1), latencyData);
                
                // Aguardar intervalo apenas se n√£o for o √∫ltimo ponto
                if (i < dataPoints - 1) {
                    await new Promise(res => setTimeout(res, intervalMs));
                }
            }
            
            // Calcular estat√≠sticas dos valores v√°lidos
            const validData = latencyData.filter(latency => latency !== null && latency > 0);
            
            if (validData.length > 0) {
                const avgLatency = validData.reduce((a, b) => a + b, 0) / validData.length;
                const sortedData = [...validData].sort((a, b) => a - b);
                const medianLatency = sortedData[Math.floor(sortedData.length / 2)];
                const minLatency = Math.min(...validData);
                const maxLatency = Math.max(...validData);
                
                // Exibir a m√©dia com 3 casas decimais
                document.getElementById('latency-result').textContent = `${avgLatency.toFixed(3)} ms`;
                
                // Log estat√≠sticas completas
                const testType = validData.length > 0 && latencyData.find(d => d !== null) ? 
                    (latencyData.some((_, i) => validData[i] !== null) ? 'Ping Real' : 'HTTP') : 'Misto';
                const successRate = `${validData.length}/${dataPoints}`;
                console.log(`üìä ${testType} (${successRate}) - M√©dia: ${avgLatency.toFixed(3)}ms, Mediana: ${medianLatency.toFixed(3)}ms, Min: ${minLatency.toFixed(3)}ms, Max: ${maxLatency.toFixed(3)}ms`);
            } else {
                document.getElementById('latency-result').textContent = 'Sem resposta';
                console.warn('‚ùå Todos os pings falharam');
            }
        }

        // --- Charting ---
        function initCharts() {
            // Mini chart options with scales
            const miniChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { 
                        enabled: true,
                        displayColors: false,
                        callbacks: {
                            title: function() {
                                return ''; // Remover t√≠tulo (√≠ndice)
                            },
                            label: function(context) {
                                // Personalizar label baseado no tipo de gr√°fico
                                const value = context.parsed.y;
                                if (value === null || value === undefined) {
                                    return 'Sem dados';
                                }
                                
                                // Detectar tipo do gr√°fico baseado na cor
                                const borderColor = context.dataset.borderColor;
                                if (borderColor === 'rgb(5,103,46)' || borderColor === 'rgb(0,66,13)') {
                                    // Gr√°fico de velocidade (download/upload)
                                    return `${value.toFixed(3)} Mbps`;
                                } else if (borderColor === 'rgb(255,210,0)') {
                                    // Gr√°fico de lat√™ncia
                                    return `${value.toFixed(3)} ms`;
                                } else {
                                    // Fallback gen√©rico
                                    return `${value.toFixed(3)}`;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        display: true,
                        grid: { display: false },
                        ticks: { 
                            maxTicksLimit: 5,
                            font: { size: 9 }
                        }
                    },
                    y: { 
                        display: true,
                        beginAtZero: true,
                        grid: { display: true, color: 'rgba(0,0,0,0.1)' },
                        ticks: { 
                            maxTicksLimit: 4,
                            font: { size: 9 }
                        }
                    }
                },
                elements: {
                    point: { radius: 2, hoverRadius: 4 },
                    line: { tension: 0.4, borderWidth: 2 }
                }
            };

            // Initialize mini charts
            downloadChart = new Chart(document.getElementById('download-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        borderColor: 'rgb(5,103,46)',
                        backgroundColor: 'rgba(5,103,46,0.1)',
                        data: [],
                        fill: true
                    }]
                },
                options: miniChartOptions
            });

            uploadChart = new Chart(document.getElementById('upload-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        borderColor: 'rgb(0,66,13)',
                        backgroundColor: 'rgba(0,66,13,0.1)',
                        data: [],
                        fill: true
                    }]
                },
                options: miniChartOptions
            });

            latencyChart = new Chart(document.getElementById('latency-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        borderColor: 'rgb(255,210,0)',
                        backgroundColor: 'rgba(255,210,0,0.2)',
                        data: [],
                        fill: true
                    }]
                },
                options: miniChartOptions
            });
        }

        function updateMiniChart(chart, labels, data) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update('none');
        }

        // Fun√ß√£o de depura√ß√£o para testar manualmente a pilha dupla
        window.testDualStack = async function() {
            console.log('üîç Testando pilha dupla manualmente...');
            try {
                const serverInfo = await fetchServerInfo();
                const currentStackTest = await fetch('/api/dual-stack-test');
                const currentStack = await currentStackTest.json();
                
                const results = await forceDualStackDetection(serverInfo, currentStack);
                console.log('üéØ Resultados:', results);
                
                ipv4Element.textContent = results.ipv4;
                ipv6Element.textContent = results.ipv6;
                updateConnectionBadges(results.ipv4, results.ipv6);
                
                return results;
            } catch (error) {
                console.error('‚ùå Erro no teste manual:', error);
                return null;
            }
        };

        // Fun√ß√£o de teste de ping real individual - para valida√ß√£o
        window.testPingReal = async function() {
            console.log('üèì Testando ping real individual...');
            
            try {
                const response = await fetch('/api/ping-real');
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Ping realizado com sucesso para ${data.clientIP}`);
                    console.log(`üìä Lat√™ncias individuais: ${data.latencies.join(', ')}ms`);
                    console.log(`üìà Estat√≠sticas:`);
                    console.log(`   - M√©dia: ${data.statistics.average.toFixed(2)}ms`);
                    console.log(`   - Mediana: ${data.statistics.median.toFixed(2)}ms`);
                    console.log(`   - Min: ${data.statistics.min}ms`);
                    console.log(`   - Max: ${data.statistics.max}ms`);
                    console.log(`üí° Compare com: ping -c 5 ${data.clientIP}`);
                    
                    return data;
                } else {
                    console.error(`‚ùå Erro no ping: ${data.error}`);
                    console.log(`üîç IP detectado: ${data.clientIP}`);
                    
                    return data;
                }
                
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                return null;
            }
        };

        // Fun√ß√£o de teste de download HTTP direto - para valida√ß√£o
        window.testDownloadHTTP = async function() {
            console.log('üîÑ Testando download HTTP direto robusto...');
            
            const result = await testDownloadSpeed();
            
            if (result !== null) {
                console.log(`‚úÖ Download HTTP bem-sucedido: ${result.toFixed(3)} Mbps`);
                return { success: true, speedMbps: result };
            } else {
                console.error('‚ùå Download HTTP falhou ap√≥s todas as tentativas');
                return { success: false, speedMbps: 0 };
            }
        };

        // Fun√ß√£o de teste de upload HTTP direto - para valida√ß√£o
        window.testUploadHTTP = async function() {
            console.log('üîÑ Testando upload HTTP direto robusto...');
            
            const result = await testUploadSpeed();
            
            if (result !== null) {
                console.log(`‚úÖ Upload HTTP bem-sucedido: ${result.toFixed(3)} Mbps`);
                return { success: true, speedMbps: result };
            } else {
                console.error('‚ùå Upload HTTP falhou ap√≥s todas as tentativas');
                return { success: false, speedMbps: 0 };
            }
        };
    </script>
</body>
</html>